{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/android-async",
    "result": {"data":{"markdownRemark":{"html":"<p>Android中可以使用异步消息处理机制来完成主线程和子线程任务调度，本文主要介绍使用Handler实现消息通信的过程。</p>\n<h2>Handler</h2>\n<h3>基本概念</h3>\n<p>使用Handler实现异步消息需要以下的组件:</p>\n<ul>\n<li>Message\r\n发送消息传递的数据对象</li>\n<li>Handler\r\n负责消息的传递和处理</li>\n<li>MessageQueue\r\n负责保存当前线程中的发送的Message，每个线程只能有一个MessageQueue</li>\n<li>Looper\r\n负责管理线程中的MessageQueue，将MessageQueue中的Message不停的取出给Handler处理。每个线程只有一个Looper</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 814px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/86b2a15f43db42534948074b87746b3e/e51eb/Handler.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 78.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdxzQwD/xAAVEAEBAAAAAAAAAAAAAAAAAAAQQf/aAAgBAQABBQJp/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGhAAAgIDAAAAAAAAAAAAAAAAAAEQESExQf/aAAgBAQABPyG2301CwGUf/9oADAMBAAIAAwAAABAjD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAQACAgMBAAAAAAAAAAAAAAEAESExcYGRsf/aAAgBAQABPxAoWhxEaUveYagcl+RXQfIANVP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Handler实现结构\"\n        title=\"Handler实现结构\"\n        src=\"/blog/static/86b2a15f43db42534948074b87746b3e/e51eb/Handler.jpg\"\n        srcset=\"/blog/static/86b2a15f43db42534948074b87746b3e/0479a/Handler.jpg 250w,\n/blog/static/86b2a15f43db42534948074b87746b3e/41099/Handler.jpg 500w,\n/blog/static/86b2a15f43db42534948074b87746b3e/e51eb/Handler.jpg 814w\"\n        sizes=\"(max-width: 814px) 100vw, 814px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>例子实现</h3>\n<p>下面的例子中布局文件中定义了一个TextView和Button，在Button点击的时候通过发送Message来实现TextView内容的更新。 使用Handler处理异步消息主要有如下的步骤:</p>\n<ul>\n<li>\n<p>初始化Looper(Looper.prepare)和MessageQueue(Looper.loop)</p>\n</li>\n<li>\n<p>根据当前的Looper创建Handler并重写handleMessage方法</p>\n</li>\n<li>\n<p>在子线程中通过Handler发送Message传递数据</p>\n</li>\n<li>\n<p>主线程处理数据(UI显示)</p>\n</li>\n<li>\n<p>主线程退出后清除Handler的任务/关闭Looper</p>\n<pre><code>public class MainActivity extends AppCompatActivity {\r\n  // 定义更新按钮文旦的标识\r\n  public static  final  int UPDATE_TEXT = 1;\r\n  private TextView textView;\r\n  private Handler handler;\r\n  private Runnable runnable;\r\n  @Override\r\n  protected void onCreate(Bundle savedInstanceState) {\r\n    super.onCreate(savedInstanceState);\r\n    setContentView(R.layout.activity_main);\r\n    textView = (TextView) findViewById(R.id.textView);\r\n    Button button = (Button) findViewById(R.id.button);\r\n    if(Looper.myLooper() == null) {\r\n      // 初始化当前线程的Looper 通过判断保证当前线程只有一个Looper\r\n      Looper.prepare();\r\n      // 开始线程中的MessageQueue\r\n      Looper.loop();\r\n    }\r\n    // 创建Handler  创建Handler必须执行Looper\r\n    handler = new Handler(Looper.myLooper()) {\r\n      @Override\r\n      public void handleMessage(@NonNull Message msg) {\r\n        // 重写消息处理方法\r\n        switch (msg.what) {\r\n          case UPDATE_TEXT:\r\n            // 获取传递的数据\r\n            String content = msg.getData().getString(\"content\");\r\n            textView.setText(content);\r\n            break;\r\n        }\r\n        super.handleMessage(msg);\r\n      }\r\n    };\r\n    button.setOnClickListener(new View.OnClickListener() {\r\n        @Override\r\n        public void onClick(View v) {\r\n          // 在子线程中通过Handler发送Message\r\n          runnable = new Runnable() {\r\n            @Override\r\n            public void run() {\r\n              // 这里可以做一些耗时操作\r\n              Message message = new Message();\r\n              Bundle bundle = new Bundle();\r\n              bundle.putString(\"content\", \"you click me!!!\");\r\n              message.setData(bundle);\r\n              message.what = UPDATE_TEXT;\r\n              handler.sendMessage(message);\r\n            }\r\n          };\r\n          runnable.run();\r\n        }\r\n    });\r\n  }\r\n  @Override\r\n  protected void onDestroy() {\r\n    // 可以在这里清除runnable/终止消息的处理\r\n    handler.removeCallbacks(runnable);\r\n    Looper.myLooper().quit();\r\n    super.onDestroy();\r\n  }\r\n}\n</code></pre>\n</li>\n</ul>\n<p><img src=\"/blog/54c35e9eba49d7862bdca4f06c052160/showHandler.gif\" alt=\"使用Handler\"></p>","frontmatter":{"date":"2021-07-09","path":"/android-async","title":"一起学Android-异步消息处理"}}},"pageContext":{"readingTime":"3 min read"}},
    "staticQueryHashes": []}