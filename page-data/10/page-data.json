{"componentChunkName":"component---src-templates-index-js","path":"/10","result":{"pageContext":{"pageAllCount":88,"group":[{"node":{"id":"33a16de5-5c3b-5ecb-9e17-c8782a7f6d22","html":"<p>本文通过图解的方式尝试生动的叙述React渲染组件的过程.</p>\n<h2>前置知识</h2>\n<h3>react渲染模式</h3>\n<ol>\n<li>Concurrent 模式  异步渲染模式,实现了基于任务的时间切片等特性</li>\n<li>legacy 模式 同步渲染模式,现在主要的渲染模式</li>\n</ol>\n<h3>react渲染阶段</h3>\n<ol>\n<li>render阶段  基于已有的Fiber树(current)构建workInprogress树 在workInprogress记录了需要进行更新的操作(effectList)</li>\n<li>commit阶段  commit分为以下三个阶段:</li>\n</ol>\n<ul>\n<li>before mutation  此时dom节点还没有渲染到页面中,执行getSnapshotBeforeUpdate周期函数和useEffect钩子函数</li>\n<li>mutation  渲染DOM 根据effectList的tag标注进行dom元素的更新,删除,替换等</li>\n<li>layout 执行useLayoutEffect等相关逻辑  进行current和workInprogress的替换</li>\n</ul>\n<h2>图解渲染</h2>\n<p>我们先假设我们的身份是React的好友,React是前端世界里面的一个一流的画师,我们希望他给我们画这样一幅画.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 370px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/bec0882c7e73e61b2e37a87e8db17ca0/1efb2/draft.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABX0lEQVQoz4WS7Y7aMBBFeQsg+DOJnQQiCA3kQ93AgirBj+5WVd//WU6F0dK0u21/XNme0YzH53qSZTlKLCi6M/70g3xdo5TCGIPR+iGpFErKkPuXJmmaIqTEKIHf9khfstp37J+OdGXGabehWhUorT9sIKX8TRPnXNgYa4mTBL874KqWxBqiKEKKBfPbKmU4R9EixOTiHns3ofc+JKyNiWOLL1b43YBdVrRtwzAMQUVR0DQtz88D2aYm3z+xWpehVmv90KihJY7jMJnbNOw/H3l5+cr1eqXvey6XC6+v3+iPJ9yyJC23uNwHrnqEY5Ikyf3JxmCNwXmP2/a0XUdd1zRNEy46n88MhwMmX6OVRERzhBDvOAZT3hjemhfVjuTTgE098/nswW86nTKbze785IjbHxx/uawVebHEbHrSLA+FY2ffGI3d/fDb3FxWUlBWNe74nbz/QhLbvxb87x/+BPj+AExOixcKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"画的模板\"\n        title=\"画的模板\"\n        src=\"/blog/static/bec0882c7e73e61b2e37a87e8db17ca0/1efb2/draft.png\"\n        srcset=\"/blog/static/bec0882c7e73e61b2e37a87e8db17ca0/63868/draft.png 250w,\n/blog/static/bec0882c7e73e61b2e37a87e8db17ca0/1efb2/draft.png 370w\"\n        sizes=\"(max-width: 370px) 100vw, 370px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span><br>\nReact大师稍加思索(babel)就把画的模板构想出下面的两张蓝图:<br>\n元素的语言表达\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 703px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/15014ea5ae1e57d91a06216d3982962b/242e2/structDraft.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJklEQVQoz5WS4W6CMBRGfY3RFiilBaRUpsLEOZ3b+z/TWVozf22J/vhymzQ5Od/NXemyRDuLnWc2m55lPzCOPet1i1I5eZ6jlErzkax0VVHmOcPhTD8dca4lE5KXLEugX9ij0JUxhmhZWUd3uRCOC4dpYJ4Du12gqqrnDMuyJCZXEtO09PM7wXtqUyGkRMYIgZQigeNbSYmQKv1n8S3Evc2qrutkURQFxjma7yvj6cjneeL69cb5PBHmBT8f2dgKv93jlwtbv+Y09ny8euYx4FxzA1pr0VonS2tritZhnMH7lhA6hqGj9QN111PrEtcP1G3H2ho6axi7hjEMSShVbprmZmcMzjlyKVGxjpD3PFU5QmLlaBr39ejy/z8brRMwzmdP5C/gD6QJ/B4bz1bsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"语言表达\"\n        title=\"语言表达\"\n        src=\"/blog/static/15014ea5ae1e57d91a06216d3982962b/242e2/structDraft.png\"\n        srcset=\"/blog/static/15014ea5ae1e57d91a06216d3982962b/63868/structDraft.png 250w,\n/blog/static/15014ea5ae1e57d91a06216d3982962b/0b533/structDraft.png 500w,\n/blog/static/15014ea5ae1e57d91a06216d3982962b/242e2/structDraft.png 703w\"\n        sizes=\"(max-width: 703px) 100vw, 703px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n元素结构\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 868px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/9f629706c2e341539b8d92bc7a0db691/748b0/draw.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 102%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABlklEQVQ4y5WU6Y7CMAyE+/4vyB8kJG5oOXogrrZBn3cn65Z2d4lkJXGd8dhjSJqmCXVdB/am/jmz+3P/u/f72ESXvvnA5/P55otxdQ+ww+D7zMrzPKxWq3A4HMx2u51Z27ZvDD3zN4aw4dHxeAy32818l8vFkuz3+zBWkdiOMgQQIBKw8w2Gihvt4RhgkRdhs9kYyHa7NXZjJf9bFFZVVaEoCjsDJoE+Ktlnhd18PjefV/vjklFZ5aJ2lmWxh/35/LVkqXw6ncL9fjfwx+MxqvLgHOLsMxQg4NfrNQIOqewt8RnEUGIAkKapGcOdpVkU588eemOgy7I0W6/XYblcxjuJNJ9DkxEBySpms9nMRuV8PtuAw44WYPhgvFgsOmxjyUKuysqUJHA6ndpDAPSIBXNiaMVkMomt8OUnEoGPNB8nquqnRmnqKwkYJ7HCzzv2DkMByqk/AwUrBtZSXKMEQxGIgPp3wdR8egjDqHz7Newkoc/EcKd8L1DiZwoQgrTTM5L58fAxMCam00N/6a+hAZZAWkoowBehpBywowW5SAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"元素结构\"\n        title=\"元素结构\"\n        src=\"/blog/static/9f629706c2e341539b8d92bc7a0db691/748b0/draw.png\"\n        srcset=\"/blog/static/9f629706c2e341539b8d92bc7a0db691/63868/draw.png 250w,\n/blog/static/9f629706c2e341539b8d92bc7a0db691/0b533/draw.png 500w,\n/blog/static/9f629706c2e341539b8d92bc7a0db691/748b0/draw.png 868w\"\n        sizes=\"(max-width: 868px) 100vw, 868px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\nReact真的是一个画术大师,他有两个最出色的技能:</p>\n<ol>\n<li>在脑海里面构想画图(workInprogress)然后一次画到画板上,画出的画大家都称赞道奇(首次渲染)</li>\n<li>在已有的画上修改(current => workInprogress) 画出的画既有原来画的痕迹又有新的神韵(触发更新)</li>\n</ol>\n<p>React欣然接受了这次的绘画任务,因为他很喜欢每次作画后大家对他的称赞,于是他开始作画了.</p>\n<h3>构思(<a href=\"https://github.com/facebook/react/blob/148f8e497c7d37a3c7ab99f01dec2692427272b1/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L991\">render阶段</a>)</h3>\n<p>React大师看了下自己空白的画布,决定先在脑海里面构造画的样子.React看到画的模板的时候第一时间是看到了各个节点之间的联系于是他对画的模板有了重新的构想.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 598px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/7d569de679597cd68a5ef34fc2a3c0cb/0c69d/fiberStruct.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 92.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtklEQVQ4y5WUSa+CQBCE+f8/igN3Ew8ejYILsrjhAi5Am6+TNgPoi2+SzgDTXVNdNYP3eDyEuN/v8nw+5XA4SBzHkuf5O9brtZxOJ10nz2o+hecCNk0jaZrK7XYTBt8Z5/NZdrud1HX9P0AKsix7A+73+4+Af4EOALfbrRbTIkDH41FZI8XPDN1dq6rS4vl8LqvVSnzf101g3c/9CTBJEjVlPB7L9XrVZ4AxxnLc/P4GXt9lWgRkMpnoHIahLJdLKctSTSOXPKtx5wFDc5m2GWjGKIpCgQG9XC4argRfWzaXeW7bVrVjwDoIApWD2Gw2yhpQq7UYnEMOMkBmEME3WDFolzyAjUSn5b7AOBxFkYxGI5lOp3oWYU27rFurMMQo5HC7fAOaIWjFkaEAdzmTLgMYIQeG0QkbuVeyw5C2aAV2gMLAbY1iO/iz2UxnOkAWY9kBtJ8A75xBNsAAnIcRMyC2xmzfTEvP1Y9FBs9mgp1FdOXWsGY5DFh/BYQhorOz/a4Wi4UKz3faxDTyueesIwHRATRQ9EAz+w/CmKCQAjZiHddZZ0YSujFjBlePwn64m35ad2/MCzzXa7RrdkvIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber结构\"\n        title=\"fiber结构\"\n        src=\"/blog/static/7d569de679597cd68a5ef34fc2a3c0cb/0c69d/fiberStruct.png\"\n        srcset=\"/blog/static/7d569de679597cd68a5ef34fc2a3c0cb/63868/fiberStruct.png 250w,\n/blog/static/7d569de679597cd68a5ef34fc2a3c0cb/0b533/fiberStruct.png 500w,\n/blog/static/7d569de679597cd68a5ef34fc2a3c0cb/0c69d/fiberStruct.png 598w\"\n        sizes=\"(max-width: 598px) 100vw, 598px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n这个是React画师特有的作画方式,还是我上次跟他一起喝醉他说漏的,哈哈我就这样把他的秘密告诉大家了,大家还是装作不知道让React来给大家讲他作画的过程把.<br>\nReact: 我在作画的时候主要思考了两件事:</p>\n<ul>\n<li>怎么把画的模板对应成更好解读的结构(<a href=\"https://github.com/facebook/react/blob/148f8e497c7d37a3c7ab99f01dec2692427272b1/packages/react-reconciler/src/ReactFiber.new.js#L110\">Fiber结构</a> <a href=\"https://github.com/facebook/react/blob/148f8e497c7d37a3c7ab99f01dec2692427272b1/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1543\">performUnitOfWork</a> <a href=\"https://github.com/facebook/react/blob/148f8e497c7d37a3c7ab99f01dec2692427272b1/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L782\">completeWork</a>)</li>\n<li>如何在构思的过程中把绘画的思路记录下来在画的过程一蹴而就(effectList 创建节点)</li>\n</ul>\n<p>经过一番构思,React想好了绘画的思路\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 885px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/6e618ddaea0eda1a9a47096488fb6ba9/efc66/renderPhase.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/0lEQVQ4y52U2W7CMBBF8/+fhQRIUF54YhGITewBwpaExJnqTDup24aqraWRrVmu7yx2kCSJOOdU8jyXx+Mht9tN0CP3+13SJC3tiH/2BX1ggCiKopDz+Sz7/V7CMJTdbieHw0EFW579EZD9er0qw+l0KqPxSBlyyb8YsgA8Ho+6A3S5XOR0Oqkty7JKoG+ApMOCTRRFEu7DN4ajkaYOIDYC8LXd4rQcBkgTACXN5XKpAJwBYI/jWGu4WCyUMb7EcMYOAcQuCtI01RS3260GrddrBfFv5qLJZKJCw7BTCpoGe7/GCgiD1Wolw+FQU7X0bIwAJP3xeKwXowNos9mUoDZ6CogCllCHgQG63GmwZYAfPugh0O/3pdfrfYwVDKmJpQcIyx8jdjpu6dpl/vrUFH9sqsbAasxu5akaH1iXKRs7U5qgNxCYAWSAvp8vPzPMnQZTO9Ltdru6W4pV/srQ/xy+PjEAo1Mk8/lcBoOBglcB/o7hew0BsadJPel8VUxZw2cMC/dRQzqN8JKshpUMnwFqU1yhbGq1mtYuiROdv09Nyd3PgPYv2tNikBlezvE91gEnbfs0fAIKaOOQPTJlg+CAM/W1C2ezmTSbzdKODlCLQcAJ5MnCCCDBfAYWYIBm/7qCVqslnU7nTV465bndbkuj0VBW9Xpd8KvSlbHv8got71ieyO6scwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"render阶段\"\n        title=\"render阶段\"\n        src=\"/blog/static/6e618ddaea0eda1a9a47096488fb6ba9/efc66/renderPhase.png\"\n        srcset=\"/blog/static/6e618ddaea0eda1a9a47096488fb6ba9/63868/renderPhase.png 250w,\n/blog/static/6e618ddaea0eda1a9a47096488fb6ba9/0b533/renderPhase.png 500w,\n/blog/static/6e618ddaea0eda1a9a47096488fb6ba9/efc66/renderPhase.png 885w\"\n        sizes=\"(max-width: 885px) 100vw, 885px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>挥墨(<a href=\"https://github.com/facebook/react/blob/148f8e497c7d37a3c7ab99f01dec2692427272b1/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1008\">commit阶段</a>)</h3>\n<p>在挥墨这个阶段对于React大师其实是小菜一碟了,因为费心的事情已经在构思阶段解决了,他主要根据之前的构思思路(effectList等)去作画就好,不过大师的作画方式还是不同于一般画师的</p>\n<ul>\n<li>在开始作画之前他要喝一杯酒,他私下跟我说这杯酒会影响之后的作画(<a href=\"https://github.com/facebook/react/blob/148f8e497c7d37a3c7ab99f01dec2692427272b1/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1800\">before mutation</a>阶段 周期函数钩子),我心想也是喝多了肯定不能画了吧</li>\n<li>在作画中,他又老能搞出一些新花样(<a href=\"https://github.com/facebook/react/blob/148f8e497c7d37a3c7ab99f01dec2692427272b1/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1818\">mutation</a> <a href=\"https://github.com/facebook/react/blob/148f8e497c7d37a3c7ab99f01dec2692427272b1/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1842\">layout</a> 组件添加到视图 生命周期函数执行),正是这些每次不同的新奇花样让他成为一个出色的画师</li>\n<li>在绘画后脑海中那个构思图成为了真实的画(<a href=\"https://github.com/facebook/react/blob/148f8e497c7d37a3c7ab99f01dec2692427272b1/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1829\">workInprogress => current</a>)</li>\n</ul>","fields":{"readingTime":{"text":"5 min read"}},"frontmatter":{"title":"图说React渲染流程","date":"2021-03-25","tags":"React","path":"/react-render-interpretation","top":null,"summary":null}}},{"node":{"id":"2f7b257b-5906-549b-9457-2cc0bd0774e8","html":"<p>React在函数组件中引入了Hooks机制使函数组件拥有了类组件的生命周期能力(本质上有差异),本文主要通过源码和图文的方式用最简化的方式来阐述React Hooks的实现原理.</p>\n<h2>前置知识</h2>\n<h3>Fiber</h3>\n<p>React为了实现时间切片,将页面的组件节点都进行了新的抽象-Fiber.通过引入Fiber结构React可以更好的实现组件更新的调度.Fiber结构主要有以下几种类型的结构:</p>\n<ol>\n<li>Fiber节点的连接结构,在组件更新时候需要依赖这些属性</li>\n<li>动态的运行数据(updateQueue,memoizedState)等,在渲染更新的时候会利用这些属性存储需要更新的操作和数据.Hooks的实现就是依赖这块的结构.</li>\n<li>Lanes 这里主要定义任务的优先级,Fiber Reconciler实现了一套新的优先级更新机制,这块在之后的文章会再介绍.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 538px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e25e72a540b8d4ed7997271e175c0bff/9516f/Fiber.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 141.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAAAsTAAALEwEAmpwYAAADcklEQVRIx5WV53LkNhCE9RjWMgeAJBgAxs1J2ZZ/uFx+/1f5XAtJt6dTSbf6MTVAgWxOs2caV2Hgk5oF+bRBH7fo+yOiqQiSGD8K8TzvW3EVhiHNYoveHOiPt4yrHUpr2ps1ejnhux6+718cV6cK9fpAu95TzVv648qCdfsVhSrsQ0EQXBxXeZFTtz1JViAzSakrVFORihTXcSzgtynHytjQqz0ilejlnigM8VwXz3O/R9n3PaKyQ5g57e6Wapgz3j8ji4IgSgniDM/1cB0Pd+bata3mtHdcu35jYQED3ycqe9Jmojs+0W6OZP0GNaxIVUE+GopekqgYNWWkKiZMAtIyITMpfuC/A30BzCSiKdD7jnJekY8leXeqMCCMfCIR2nWcRTafXg7jgDB9bSv3Jc4V5iXSaOrVRP9wS3dzQJYS0Q4IlRGEPlEa2ghf8499EtgPhkn4S4VaoaaGam3ITYY0FbLJyHuBqBOyVlAM0mZpUpvtWZWQd8L+gjNgPZI2c8z2jma+RRQ1absmjhOcmXMWxXFf8znezt5TVoa0GWyD18sdZdsT1z1pUeF7l0/Ka4UeUTWS1CP98U+qcY3uB+JE4PsBfhB8fPFrwJMoyopSTi1CpYjeIGuJ5zk419c4s+vXPMPz/Hd996GxX0TJkaam2Yw0mwV6t6TZ9IhckpuBoptQ/Zys1l+CnQGrAWFWTI//0N08Mz39S3d4otQtanlDOa6RtUaoitNk/R5QtQgzMdz9RXt4YLj/m3paISpjxzKKIpzrP3CdSymr1qrc3zxhDg+0h0erdlFrEr1AqvonAO8yyrJfs3j+j253R3/7TLe7JYwioqKx2buwfV5FEaRVhhobEhmRqpxY5i/2NbvGc50PrvI1YGlI6xazO1DPF2TDkmR+RAwbokwRJJIgCC+q8mxf9US7e8ScYn9v7xnZLSxw0q+JUmErvpByTj5ozHFOvR3J6oYoCAhlyenO8ay63xGlqBFaY/YbqrElLg1Bv7XzHLhnZ35z69+3TdEgdEe9XNOstuj9kaLtEIst2e6GrG0J4xdT/dmhP7lTTrOck48NejdQrwaazclYBdloKFc1WSuRTWq9781IPwVM4tgqGUqFrAyZ7slOExIlRFlNGEYvlN3zVfkl5dNYBZ5nx8qdzayzuNZV3F/EeG9Tn1X4P50bH358JSUOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fiber结构\"\n        title=\"Fiber结构\"\n        src=\"/blog/static/e25e72a540b8d4ed7997271e175c0bff/9516f/Fiber.png\"\n        srcset=\"/blog/static/e25e72a540b8d4ed7997271e175c0bff/63868/Fiber.png 250w,\n/blog/static/e25e72a540b8d4ed7997271e175c0bff/0b533/Fiber.png 500w,\n/blog/static/e25e72a540b8d4ed7997271e175c0bff/9516f/Fiber.png 538w\"\n        sizes=\"(max-width: 538px) 100vw, 538px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>update</h3>\n<p>react在处理更新中引入了update的概念,在触发更新的时候React将update插入到对应的updateQueue中然后调度页面的渲染更新.最后通过updateQueue的执行来完成更新.</p>\n<h3>React Fiber Reconciler</h3>\n<p>React为了实现更新可中断等特性,在具体的渲染过程中会维护两个数据结构:</p>\n<ol>\n<li>current Fiber树结构  当前展示的页面结构</li>\n<li>workInprogress树结构 在更新中添加了更新但是没有渲染到页面的结构</li>\n</ol>\n<p>在具体的渲染过程中主要分为:</p>\n<ol>\n<li>render阶段 render阶段主要根据已有的Fiber节点构造对应的workInProgress节点 这个阶段实现了任务的中断,优先级任务处理等逻辑</li>\n<li>commit阶段 commit阶段主要根据Fiber节点的类型不同来执行对应的更新操作(更新Dom等)</li>\n</ol>\n<h3>Hook的数据结构</h3>\n<p><a href=\"https://github.com/facebook/react/blob/0203b6567c6fd6274866c853ef938241d24551ec/packages/react-reconciler/src/ReactFiberHooks.new.js#L140\">hook的数据结构</a>如下:<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 477px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.599999999999994%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABuklEQVQoz12S6W7bMBCE/RiJJR6iSFESJR8SLV9xbMcJkrRpgbz/w3yF7RxIf8zOLkgOONgZ5eUYYTIeult+bxLKpcfWhiRJkVJeIIRACkEq5AXn+RNf5x93R9ooYuh5iWu6psQuD/jVQHW/IrQNw7C4PlASowUuS1FaIrX8IfbJI+UbrHX0z+802xPd6Y3++Mx6s6ONKyZxQGcp+dSy3yreNzc0y4KwLcnLjDT5/t1F8FxsUdA9vNIdn+kfXqjbCZP7I9Z7tDFordEmJ880uRZIkyGVQsqfYlfBzGBdQXz6Q3d8Zbp/pF0tyQ4b7GHD/PBIPdxTL+7o1nvKukYPPXmoEUlKeoG48jhlpJs51uY06y3ToaeMNcVhgdt0mDihPw28nSJxEeif9sxjwC5nuNhiS4MLOcZn2JBTTCwj3fZoLSm7OXUMlHczfF9RTT35NNBGx6/1Dbujwy8L2sHx96SIiwwTLH7mcK3FT92lH8ncEReRyWpH5StUE1DekzmHDhVKZaSZxlQGdWYtOM7G1CZhfPth9cPuxbIUKbM2oERKkowRSYJI0yvO/WcGk+/s3Y6vefx/Ieel/AOaqgbxYD1/+wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"hook的数据结构\"\n        title=\"hook的数据结构\"\n        src=\"/blog/static/c3abb96049ba35de696bfaeac50d17b8/d743b/hook.png\"\n        srcset=\"/blog/static/c3abb96049ba35de696bfaeac50d17b8/63868/hook.png 250w,\n/blog/static/c3abb96049ba35de696bfaeac50d17b8/d743b/hook.png 477w\"\n        sizes=\"(max-width: 477px) 100vw, 477px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2>Hooks实现思路</h2>\n<p>Hooks在组件初次挂载和组件更新阶段是调用的不同的<a href=\"https://github.com/facebook/react/blob/1d1e49cfa453b58769e87c3c8d321024d58c948f/packages/react-reconciler/src/ReactFiberHooks.new.js#L389\">实现逻辑</a>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 561px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABh0lEQVQoz12RW5LaMBRE2caAJOthy5Yf2NgYg4cZBuaZqmwgO8j+N3BSCFKZykdX36+jVvfCWEsTajZhTZo6pFghpUBIiVQSldx1vZVCJYpEJ7dbqpvHWyKlZGGMwWWeamgJU41tCsquoN/ldHNFMZaUu5uyxpLVhnxj0VYhhIiPR93BC6MTdFHh9i/43RNuODBNAz+eB86PW4qup5lm2scToe1wRcA3bXRjNNqmJDb7ntCSKIXPc+rjK/XzB1+niffTgf00kh8/KS8/8eue0O8Im5FymMjbgTIE0qImSYsIjAmtMUSoEJhmi9u/8evS8fur4+04IsZX7PyJrTrEwwNitUKsljcJgbh2Hr9+T+icI8sc2imM19jgSIPD5A6dWbS30dMyxVqNWC4j4JomSZJ/o/zt0DqHrRvqQ8/mcqQ7jfTHNU8fW+bzht15y+ZlZj13tIcD5bCn6rdcx/wfdhvFWJRJMc7j8gptPUZrqpBT5BlZ5mNPxmZYH0jLGl/WESjvvX0H/gH+iejWe9cPNwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"挂载不同的hook\"\n        title=\"挂载不同的hook\"\n        src=\"/blog/static/79d42a604971a40c38b3cd9a50682d77/410f3/different_hook.png\"\n        srcset=\"/blog/static/79d42a604971a40c38b3cd9a50682d77/63868/different_hook.png 250w,\n/blog/static/79d42a604971a40c38b3cd9a50682d77/0b533/different_hook.png 500w,\n/blog/static/79d42a604971a40c38b3cd9a50682d77/410f3/different_hook.png 561w\"\n        sizes=\"(max-width: 561px) 100vw, 561px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 501px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 86%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC2UlEQVQ4y3WTyXLrNhRE/RGpLCxxEmdwAMRZokRNfJKVOMvsUtnm/7/gpEDZtPwqWTQuCkU0+t5uvqyCJY5I8JTArRR+uybqC8S+JOr0vkEcWqI6I94mxENOuM2IuoSsFsTrEFessGwLwzB4MU0LX1bkdYs6nEl3J8J6x1KUGKLAlB1G1mIGKXEmyNsS2RTEWUIcx/i+z+J1gWmaE15WhoEQPuOl5XQoGc81SgmS2EVmAZnwWMuQRAQYyyWmxmIx1eVyOanSRIZpPBQahkmaxozjht2+4nRuSfKM263n9tZzPnfs9jVxHKK/NcwPGMYX2VOdCJMk4nLpOB5rqloiVcr53HI41Ox2JUKEvL4usKxHW7rato1tW98Ip5YfCiOOp2ZSud9XDEM1Ky5rxfHYTI9dxm56YLNZT4/1fUEQeCyXT4R60Qq1ov1Qsd0WDENJuykoypy2lVRVNhG1raLrFEJELBaP+VmW9V3hJ+H9tx1v9z1Vo6aZ3W5b3t8HpBSzCt22JnpW9PMcZ8K3t57h0EztFLXi8qMnzRNUkZLnMauVM8/vk+y/8GXK2LHtS1Qp+eua8c/vGX+fQvrU4pdfX1ksFt9j8uHyz5gVjmPH9brlcGx4P0rufcKfo+SPsWY/NJNRdZ3jee5E/L8K9aJzqHOnM6gvnsYt3b5h3ZQcz93kuI6VToB2t+vWSJl9jMCaq8Yc7NOpmXOnL9banF3FYajm82GoyTKB6zpTBrVJzw4/5TDmft9xvfb8uG4n6MvNpmTbPzJ5vfVcnqpSKbEIcBznQfo5Qy3T911UHrJWMUrG5GmAiFakwp/UpImPkhHFhHBC+vGvu471NdNPU9wgws9LoqLFFTlxtSHpBgJZEsoCP1UYXoSZ1Zhqg7nusfIGI5bYaYnjehjGg/TFc13WdYUnMoJM4kUxYaaIZEGQ5ngixYsEdhBhixwnkTjpetrbUYoVCmxnNQf7XxK2AFDTeZdbAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mount阶段hook\"\n        title=\"mount阶段hook\"\n        src=\"/blog/static/55b46db6b69afb0beaa46bd58608e2fb/55811/mountHookCode.png\"\n        srcset=\"/blog/static/55b46db6b69afb0beaa46bd58608e2fb/63868/mountHookCode.png 250w,\n/blog/static/55b46db6b69afb0beaa46bd58608e2fb/0b533/mountHookCode.png 500w,\n/blog/static/55b46db6b69afb0beaa46bd58608e2fb/55811/mountHookCode.png 501w\"\n        sizes=\"(max-width: 501px) 100vw, 501px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 485px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.60000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC5ElEQVQ4y31UWXLiShD0NWwQvbc2hCS0byBWY3vuf52c6MIm7Bi/91FUtEKR5KZ+YpxD5x3kOodq9jDDBbIcIZsZshgh6xlquEJ2J+h1inVXYj02SMYaQZYgCkMIIeB5HlarFZ7cj7YW075GO1ZopwbpNoMnFDwu7iM0llxhxTiMVjDW0JZSgDNGQA9Axhg4W8EaBaMlrJFQSkBwBqU4pORQgkFrAc4Zlsvlt/EI6AvM7SfPWyEIDI7HBtNU0s6LFHWT4fY2Yrer6Lnb6ySEe5+xFQF8nwfDB+CpJbBhLBFEIU6nhp6dzy2GYYvFwsPz8wsWizs7t5+fF3h5WfzO8HRqsd9XaJoMZZXi42PC5dyiKDeo6hTbbYJkEyJNI3p/swlRVRtkWQQh+HeGHqLI4nBsCPT8Cbzf18i3G+znGpdrj7e3kSz4+LPD4VCjqlJkeYwsi6GU/CnZ9w0ulw7nS49su8E8V5jnGvOhQd9vKU1jFKyvoV1wVoNz/mnBL5J9X+N67Qm06wukeULeubPzsW0zJEn06Z9HHn6B/Gcor689hrEi/3b7is7TVBErYySx/D+gryHAMLQ4nzvMhxplnWEcS/LUyXZ1ieOAOujkOqmOqZvvUn8ABqF5SHbAh0ODqsnRDwUFcn3tcbsNFMYwFIgiH9YquI/iV4bOQ5fwtCvRtBklO4wF8uKesuunA+u6nABdUGW5gZTyH5YPyU6u+yKczHEqsS1SYkh/NJXEepoKssCl7KriAvql2B4Bvr1PuL4OOF866ptj5WR3g/Ozxe024vU23Dv5PlHFXOlTV2z547ZhdAFEgUISG8SRQRgoGMXg2/uF4FuJdWyxjjQ2a4M4kAitQGAF4lBDsBWWD0DPgzA+4mZCMhxhkhzrbo/t8Z12VHWIqgEyiLHKevBqhuiu4PURPB/AshYiKegaI8lSCKRpBi4VpLH3sT6N0AZCaRouBJjSYNqCGf++3VlqMKEeHv4Fc1cdpF0sQpIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"update阶段hook\"\n        title=\"update阶段hook\"\n        src=\"/blog/static/25312134b5bc77843da2562709c24e6e/44c61/updateHookCode.png\"\n        srcset=\"/blog/static/25312134b5bc77843da2562709c24e6e/63868/updateHookCode.png 250w,\n/blog/static/25312134b5bc77843da2562709c24e6e/44c61/updateHookCode.png 485w\"\n        sizes=\"(max-width: 485px) 100vw, 485px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n下面先整体的介绍不同阶段Hooks的实现过程然后在深入到源码中看具体的实现.</p>\n<h3>图解hooks的实现思路</h3>\n<p>Mount阶段Hooks的实现逻辑\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 652px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/38746c08a5fcd5ae402c6fdb39b40b99/a6d32/MountHook.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAZABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe41ACywA//EABgQAQEBAQEAAAAAAAAAAAAAAAABEBEx/9oACAEBAAEFAuuplTxU2P/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CT//EABgQAAMBAQAAAAAAAAAAAAAAAAABMRAh/9oACAEBAAE/IahEZ0sjaDhY4Qf/2gAMAwEAAgADAAAAEPMPDP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EAB0QAQEAAgIDAQAAAAAAAAAAAAERABAhMWFxgaH/2gAIAQEAAT8Qrh+MUpA9kxcjfuquM850VugMJcJEJNd2j//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Mount阶段hook逻辑\"\n        title=\"Mount阶段hook逻辑\"\n        src=\"/blog/static/38746c08a5fcd5ae402c6fdb39b40b99/a6d32/MountHook.jpg\"\n        srcset=\"/blog/static/38746c08a5fcd5ae402c6fdb39b40b99/0479a/MountHook.jpg 250w,\n/blog/static/38746c08a5fcd5ae402c6fdb39b40b99/41099/MountHook.jpg 500w,\n/blog/static/38746c08a5fcd5ae402c6fdb39b40b99/a6d32/MountHook.jpg 652w\"\n        sizes=\"(max-width: 652px) 100vw, 652px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span><br>\nUpdate阶段Hooks的实现逻辑<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 685px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/acf124ecaccb1c0fb4fe2140077cba9c/0a2b8/updateHook.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 149.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAeABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe41koLnUIo//8QAGhAAAgIDAAAAAAAAAAAAAAAAARAAAhEhMf/aAAgBAQABBQLMJ0jwK0CK/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAFBABAAAAAAAAAAAAAAAAAAAAMP/aAAgBAQAGPwJP/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAEQETEh/9oACAEBAAE/IdYaKYuqbENSG5CWhYf/2gAMAwEAAgADAAAAELPKMP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EABsQAQACAgMAAAAAAAAAAAAAAAEAERAxIVGB/9oACAEBAAE/ELWLcdRBAK7jpXG6a8By34Qa79MFQlwgKCp//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Mount阶段hook逻辑\"\n        title=\"Mount阶段hook逻辑\"\n        src=\"/blog/static/acf124ecaccb1c0fb4fe2140077cba9c/0a2b8/updateHook.jpg\"\n        srcset=\"/blog/static/acf124ecaccb1c0fb4fe2140077cba9c/0479a/updateHook.jpg 250w,\n/blog/static/acf124ecaccb1c0fb4fe2140077cba9c/41099/updateHook.jpg 500w,\n/blog/static/acf124ecaccb1c0fb4fe2140077cba9c/0a2b8/updateHook.jpg 685w\"\n        sizes=\"(max-width: 685px) 100vw, 685px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>源码解析hooks的实现思路</h3>\n<p>以下主要以useState这个hook来分析React在mount阶段和update阶段的源码实现.</p>\n<h4>mount阶段源码分析</h4>\n<p>在mount阶段组件,useState调用的<a href=\"https://github.com/facebook/react/blob/1d1e49cfa453b58769e87c3c8d321024d58c948f/packages/react-reconciler/src/ReactFiberHooks.new.js#L1235\">mountState</a><br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 548px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 107.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAADoUlEQVQ4y22U23LcNhBE9Rn28gKCAAEQvC+X3OVyL9JasqWU/QGpylP+/x9OilQiy4ofmoPCQ3Ma0z13URSjfYXvR4ax4++vnr/uDX9eLO22RbmcREqiJGGz2bAJAqIwIo5joui1vsfd8im85XjsGc8Du9tMO+8ZzzO7457Dw4npeqQ+9NR9y9B3GGcJw/CN5D3xXRxHZK6g2J2wuyP29MgwdDx9O/Ht+cSXxyP3t4mH28TXx5k/ns7s+o4kka+dRr+Srh1abTGZI+lGRNlRtpZhX7HbV/RDSV56jNF0PqOvLE3lyMucRAli8aFDIQRJkpAXGbtDyTjX7C8trrTU25x+qhjPDbt9jW880iakTiJNQlYqhBTvCCPulj9YYzBZiss1zmlyp5FSYIxaz84qnNUomRJuAsIwIghCgk241vDdkO7SLEAZi6o9xbHGTzX+UOH3NaZe7h2685gmR2aGVGdImaB1is7S9adpKn++oVQhqc3R+wPtdaa7n2mvZ+rzTNlX6G2HPRyo55linHHtDpNptttyxTDUVJUniv6VLHVIqg2qKtFdgR53uMbihhY7DTSnkWJs8JUhCgPCxYdRRBi8yg2C4M1Cq+TlIJUmH69Ulxfc8RGZd6hyR6wcOq+R2pEIuXaxvNeC6IOh3yQvU5aJoBz27J9e2M5nTNPjtwNKxog4RIoQlcZoJdbhZUoixP+Tsna4EAqR0Pcl379feHk58fw88+PHdTVzs+s5fbnn9PjA9fmJ6+OZ6ctEWRWr7N9Gz1lHVXgKb/Aue0Vu1kmKVCOtR7kC5SukNljvsCb7fZaXS5MXlMcLcdEQdRNhM5J4j596yn2PsRmfP31i8/kzwWZDsAnYbII3wg9JiSmMoZkG6vsz1e1G+3hj+3Bhfroxjj15btboWZuRZQqdqfW8JOxjl3cijtn6nCIvsbszqujwZUPVHzCuwKRyfd/FbwsW77VtwTg2KJX+snXeZVmgq45yP5NvB8rDmXy3X1HN92hfs/m87ML/vBf+IvnDUARKStJuws7fUMvWSTNEote6IkmJwvgdohVh8BPr3WqbNMIZg64r6suJujUIGZDaiNS8QmYxyiZoJ1BWkC4bx6aoPEW51yp18m+WdUiWGbqhpj3U+OtEPo30Tye625H+64XmPJDvW/z9EX+Z8GOD9ilZqckKta6xNJOvhIlM8XVNbh2ZNsSmRLoKU3Zr7Fa4EpFaYtcgbIVIs9XUHyUvhP8Axs1mSXuqYs4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mountState代码逻辑\"\n        title=\"mountState代码逻辑\"\n        src=\"/blog/static/52a5be7aa726b705f79a180697dd6fe8/a58fe/mountState.png\"\n        srcset=\"/blog/static/52a5be7aa726b705f79a180697dd6fe8/63868/mountState.png 250w,\n/blog/static/52a5be7aa726b705f79a180697dd6fe8/0b533/mountState.png 500w,\n/blog/static/52a5be7aa726b705f79a180697dd6fe8/a58fe/mountState.png 548w\"\n        sizes=\"(max-width: 548px) 100vw, 548px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><br>\nmountState主要做了:</p>\n<ol>\n<li>根据initialState初始化memoizedState和更新queue</li>\n<li>返回memoizedState和更新函数(绑定了当前的hook的queue)</li>\n</ol>\n<h4>update阶段源码分析</h4>\n<p>在使用useState返回的回调触发页面更新的时候是调用的<a href=\"https://github.com/facebook/react/blob/1d1e49cfa453b58769e87c3c8d321024d58c948f/packages/react-reconciler/src/ReactFiberHooks.new.js#L1901\">dispatchAction函数</a><br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 485px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 142.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEE0lEQVRIx5WVZ3LbSBSEdYy1CEwexAEIEgRzkinJYe3avf9lvq0BJZVkOdT+6HoDFNmYfqlvpFRUw5bp6RNlG9g+bljtZlReEgpNmSmcc1hrEFKSpilCiF/iRkpBvdyxuHylmnVMH09M7/aUhw3tbk0z7+jmHVopkiey35HeaGNol5uRtOrmhKbCCYGTEicFXimsUggh3/35Z8Q33vuRJLn9QDK5JZ3cjjFJJuON0uSWNJkgXiFNkheyH0lvjNYI41FZjfQFqu6Q9YzUVwhtmfjAxAUS3zBxNYmvsb7A6J+nYCQ07QrbH9DdCrd7IOsGloct203P+v6B/efPLD9eWF8+0py/Mnz6l+l0SpIk7yVHQh0W6DAgQ487fcOHKdPdnOnDgeG4ZLGe0fUNy74lyzNsXmKt+4VkY5DGEbZ3FLMB4Quk9bjMUdQlZZFTZh5nLbHF4q2uOU5II0nM8xvJxqCUojtcmJ/ux557TnoySZhMkivJq0K8IJK9kxwJjWH+8Qv9/Tf6+79ptydc3aLCApNXSJH+sV3eSpaKxeN3uuOF+d2nkdCEOeVii9b6j9ORvpJ9Y43B+2xsbFfUlM2UvJ2T1w3T1Y5YtGe5L0je4t0Nq1ChjEA5ibQSqQVCpSgnUCY+K5RVKBOjRHuFzq7niNcfu7Gxeial6B3Tc0U5s+StIWwL6nVG3hnymaFeO8ImJwzV+BFbGIzXmEz/eENN2Q90hz3FekF+OONWe8quor/c0R0PY1x8ume4nMhy/06mlPIFo+R2GqiHLWbziFpeKIc9TWixsz1VN1CFKUI6jCve5e8FT7kdCbUWmMLh5wHblGShoOwyTJ3hmwxfGbLOYnI1SsymDltoTK5xlcEHO76P5yuhsfjtBbc8UPUL6mGFyzx2dcStDriiQMgJUgmEFMhYKCWeEIsmr++VuBYlL0rq3YUQW8dnaOuvOfEFwmbjaBqXoZR+2z4/wXhDoTTu+BWz/0y9PTM73lNUNW73iD1/p9jc0QwbsiqMY/lbC4heYZ1HtsMI0/bk7QxflOgyoPs9tmrGxft6Yn41PaPkajojqwNZWVG0HXloRw8RcdkWARn95DZu8skY0zT5tQXEWW02JxYP3ylXZ8rjF+q772SzFdXmTPvwD/ViTdH1VIs19bAZFf0o/WWWYw5dmVMNgXBqyBaBfNUgYxFEis0LrM9xRTUuVl+FsStGgvT9FnpasCl572iPJWGXU608QsSFIJhMJuMPJ9HEonF9+GuMo3FFJ0yTt9smEvaLltN5yWY74+NlzfluyXY353DoWa9nNKs9Tdw8RY1dnrBVi14c0fMdbnmirMOV9NlGn41cKYnWakQ8P0NIhdRPS0Dp8fka5Rhjzz5bwU1c+dEC3u28/4unKv8HIjYjhkrSpr8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dispatchAction代码逻辑\"\n        title=\"dispatchAction代码逻辑\"\n        src=\"/blog/static/ffb63f0539dcde4bca5e0f77c2ba284d/44c61/dispatchAction.png\"\n        srcset=\"/blog/static/ffb63f0539dcde4bca5e0f77c2ba284d/63868/dispatchAction.png 250w,\n/blog/static/ffb63f0539dcde4bca5e0f77c2ba284d/44c61/dispatchAction.png 485w\"\n        sizes=\"(max-width: 485px) 100vw, 485px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><br>\n在组件更新执行到对应的函数组件的时候,会执行对应hook的update阶段对应的hook逻辑.useState对应的就是<a href=\"https://github.com/facebook/react/blob/1d1e49cfa453b58769e87c3c8d321024d58c948f/packages/react-reconciler/src/ReactFiberHooks.new.js#L1262\">updateState</a>.从updateState的代码可以看出useState底层是使用的useReducer代码逻辑.这样具体的更新逻辑就在<a href=\"https://github.com/facebook/react/blob/1d1e49cfa453b58769e87c3c8d321024d58c948f/packages/react-reconciler/src/ReactFiberHooks.new.js#L710\">updateReducer</a>中了!!!\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 570px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 152.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEZElEQVRIx42V627cOBaE/Rg77pZ4E0mJut/VdrfdcWIn2SAXLPbH/pknmEeYh/8Wkp0gcOJMfhRIUFDplFh1zoUwlmqcqMeBfqg4HGemZaAZW/KmpMg8oQhIKYmiiDiOf4kLEccMVwvL+ZZmPjKMM3mWYROL0opov3/EE9nz9QdCpTXF4YZyWnBdRzZNuDxDbRW9XMmLhFpryjylrXPqsaYeaoauJnjLfndJtN89w/6XVV7EQiB9ifAFohxQNkWEFlEvqGpGVROyGJDFiKhm0rJBq5f/54WQEt0e0PWMO38gGxbcckc4f6R7+ELaLcTKYHyK8gGlDHEcEb14KVJhljck/YlweEV195Hi+pb6/i3N4YZ6OdFOM68/vGNcRnRI0do8XVb0Ay6EEOgsJSlTTBkwRSDrM4oxJ60dWVuQ9TVp35K2OdVUEKoUmQi0V5hMo53CpApp5COh8THp4nCTJWkMaZ9QXDnCYjG1JvYxcRpjgiIWEULFCCWQWiAT+bgasZ1thDIEjq9K3ryquLkOmMQgbEpsM9oy5TwUnPocazT7VVr0hOeSo4iLNQEubfjz3YG//3fDX58WuqZENTOiueJmbnk7ZdxPAZ9o9v+QlgspBEliqPucfspphkAoHdOcMTSOsrbEmWGnInaXu1+a+lv0pMuQ5YSuBlR/TVEEPt8f+O/7Ew9317SvHqimBW2Sf8zzhRAx0q43PDA9fGR695lqOWLrAVnP2PZAVjW4qsNmYbPLbxHqsqd//Z7p/Rf6Nx/ozvcU4wFfNqi8Q2nDfve7km2GKSeGh88M95+ojm8oz/8mdDM6SdF5j1L6N9uXEAitN1O3d1dUxxbfOuxQkXYeWyqSIDcjPyd8oTnEpImnLgu0F+hUbglQ+sm8Rm7YCJ78tt9FL3acx+gpjbYaN1jCwZONDlsmKKtQaxKM2OK17pWVmKAR8oUKpZCspD51jF1D1RfodJWpcVXymFWvsKXZzmxh8K3dqv8p4RY9KTFa05aBckxxjd6w/oJ1TXJFUhpck3B5uefyX7tN+lfJ3xN/I9xInSZfKrKhJIwVWV9RnTp8k2GMwjpFliXbfn1v/5Pu/UioFEpIQqgY336iubmnmg6Md++Y3v+H8nBDezgxHE8cz1f080xVNyTeIZ5dzEaopEJIQVP1LPOJUJWI3SWJdRifoa0jyUuUS1HGkaQ5qfdYZ39O+FXy+kWZOIR2REmKEAptPSrxSGW2/frSmphV7lfJ32NrX+soXcem9hm2rfFLh5tnXJlRna5pzgfysaM8zGhjiJ/yvBbzo21WQqW2CrOqpj3fUh8Xiibl6twyzgXt7UJzviUfWlQo0c2MDzlRtH8hekJiE4Pzjkgookiw++MSGUeo9bnUSJ1ssoXSxNtePcr8zjqb5HWMrqRZ0+GrlnXwu6LClQ1JKND2ceBv+Dro97ufWuZbhYkx9P0143RDNS709x9plmvKYcHWE0VeELqJrJ/xaYrLAr7ucd7/IPv/GmRg+gK7bPkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dispatchAction代码逻辑\"\n        title=\"dispatchAction代码逻辑\"\n        src=\"/blog/static/275788fe27b5e1522a0d62b15f3b7910/432e7/updateReducer.png\"\n        srcset=\"/blog/static/275788fe27b5e1522a0d62b15f3b7910/63868/updateReducer.png 250w,\n/blog/static/275788fe27b5e1522a0d62b15f3b7910/0b533/updateReducer.png 500w,\n/blog/static/275788fe27b5e1522a0d62b15f3b7910/432e7/updateReducer.png 570w\"\n        sizes=\"(max-width: 570px) 100vw, 570px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><br>\nupdateReducer主要逻辑如下:</p>\n<ol>\n<li>根据fiber上存储的hook链表获取到当前的hook,hook的更新queue</li>\n<li>循环执行hook的更新queue,将执行结果保存到hook的数据结构上</li>\n<li>返回处理结果和更新函数</li>\n</ol>\n<p>以上梳理完了React Hook的源码执行流程,也能解决开发中的一些疑问:</p>\n<ol>\n<li>比如hook的添加为什么不能使用条件语句  因为前后会导致hook的链表无法对应</li>\n</ol>\n<h2>参考</h2>\n<p><a href=\"https://react.iamkasong.com/hooks/prepare.html#%E4%BB%8Elogo%E8%81%8A%E8%B5%B7\">React技术揭秘</a></p>","fields":{"readingTime":{"text":"5 min read"}},"frontmatter":{"title":"React Hooks源码解读","date":"2021-03-17","tags":"React","path":"/react-hooks","top":null,"summary":null}}},{"node":{"id":"1afb6c25-089f-57eb-9a85-e631e71ad1cd","html":"<p>javascript的执行是单线程的,React老的架构是利用栈(递归)来完成组件的更新渲染,这样当组件层级较深更新任务较多的时候,js线程会阻塞UI线程导致表现上页面卡顿的现象.React新的架构Fiber中将更新任务进行了<a href=\"https://github.com/facebook/react/blob/f227e7f26b81cb1eba0c837ab2acd7fa7f91404f/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1472\">细粒度的划分</a>并且实现了新的任务调度系统.这样保证了React页面更新的流畅和响应的速度.本文主要从调度React更新任务的Scheduler包入手从宏观的角度了解React中的任务调度机制.</p>\n<h2>前置知识</h2>\n<h3>事件循环</h3>\n<p>javascript中的事件循环可以参考<a href=\"https://icantunderstand.github.io/blog/event-loop\">事件循环</a></p>\n<h3>isInputPenging</h3>\n<p>isInputPending是Facebook实现的一个浏览器的新的api标准,现在只在最新的chrome版本上有对应的实现.通过调用navigator.scheduling.isInputPending方法来获取当前是否有高优先级的用户输入需要处理,从而实现打断js执行响应用户输入的目的.</p>\n<h2>任务调度的演进过程</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 943px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/08a926bcf0d7610b88cd024eff38d4ba/2b51a/scheduler_long_task.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAG6AD//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAXEAEBAQEAAAAAAAAAAAAAAAAAEQFB/9oACAEBAAE/Id4qv//aAAwDAQACAAMAAAAQc8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAYEAADAQEAAAAAAAAAAAAAAAAAASERYf/aAAgBAQABPxB24lpLzGLhn//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"长时间执行任务\"\n        title=\"长时间执行任务\"\n        src=\"/blog/static/08a926bcf0d7610b88cd024eff38d4ba/2b51a/scheduler_long_task.jpg\"\n        srcset=\"/blog/static/08a926bcf0d7610b88cd024eff38d4ba/0479a/scheduler_long_task.jpg 250w,\n/blog/static/08a926bcf0d7610b88cd024eff38d4ba/41099/scheduler_long_task.jpg 500w,\n/blog/static/08a926bcf0d7610b88cd024eff38d4ba/2b51a/scheduler_long_task.jpg 943w\"\n        sizes=\"(max-width: 943px) 100vw, 943px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span><br>\n当js线程执行一个比较长时间的js任务的时候,会导致UI线程无法快速的响应用户的输入,造成体验卡顿等问题.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/71f0d49fe6d23486141918239a4604af/faa66/scheduler_split_task.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3AUH/8QAFhAAAwAAAAAAAAAAAAAAAAAAABAR/9oACAEBAAEFAir/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAWEAEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQEAAT8huqV//9oADAMBAAIAAwAAABBwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQACAgMAAAAAAAAAAAAAAAEAESExQVGR/9oACAEBAAE/EAlxd53DoPYN4J//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"任务分片\"\n        title=\"任务分片\"\n        src=\"/blog/static/71f0d49fe6d23486141918239a4604af/a2510/scheduler_split_task.jpg\"\n        srcset=\"/blog/static/71f0d49fe6d23486141918239a4604af/0479a/scheduler_split_task.jpg 250w,\n/blog/static/71f0d49fe6d23486141918239a4604af/41099/scheduler_split_task.jpg 500w,\n/blog/static/71f0d49fe6d23486141918239a4604af/a2510/scheduler_split_task.jpg 1000w,\n/blog/static/71f0d49fe6d23486141918239a4604af/faa66/scheduler_split_task.jpg 1056w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n将长时间执行的任务划分成多个短时间执行的任务,能有效的降低js执行线程卡死的状态,这样就引入另一个问题就是如何划分任务切片才能产生更好的UI体验.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 792px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/150e0b4d08aa0861f4343a41e1c4da61/4dfa3/scheduler_continuous_task.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe4g0o//xAAYEAACAwAAAAAAAAAAAAAAAAAAAQIQIf/aAAgBAQABBQK5CeH/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAbEAEBAQACAwAAAAAAAAAAAAABABEhMUFhgf/aAAgBAQABPyHfTfGHfDJ6LLDscl//2gAMAwEAAgADAAAAEIMP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAMAAwEAAAAAAAAAAAAAAQARITFBUXH/2gAIAQEAAT8QU31Z1sLKHX5kQcH2UGzTklACfYqEvfZ//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"任务调度\"\n        title=\"任务调度\"\n        src=\"/blog/static/150e0b4d08aa0861f4343a41e1c4da61/4dfa3/scheduler_continuous_task.jpg\"\n        srcset=\"/blog/static/150e0b4d08aa0861f4343a41e1c4da61/0479a/scheduler_continuous_task.jpg 250w,\n/blog/static/150e0b4d08aa0861f4343a41e1c4da61/41099/scheduler_continuous_task.jpg 500w,\n/blog/static/150e0b4d08aa0861f4343a41e1c4da61/4dfa3/scheduler_continuous_task.jpg 792w\"\n        sizes=\"(max-width: 792px) 100vw, 792px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span><br>\n基于以上两种模式的思路,js如果能在执行过程中主动的获取用户的输入(执行的deadline),主动的暂停当前js的执行并通过事件循环在下一次的事件循环中再次唤起js任务的执行，这样就能充分的利用起所有的执行时间来执行任务并且保证用户输入(高优先级任务)的响应，以上就是Scheduler在调度任务执行的实现方式，下面从源码的角度来看下Scheduler是如何实现任务调度的.</p>\n<h2>Scheduler的实现思路</h2>\n<p>以下源码分析基于React master分支的<a href=\"https://github.com/facebook/react/blob/master/packages/src/forks/SchedulerDOM.js\">最新代码</a></p>\n<p>在React进行渲染任务调度的时候,是通过调用Scheduler暴露出来的unstable_scheduleCallback将任务函数作为callback传入等待Scheduler调度执行.<a href=\"https://github.com/facebook/react/blob/00d4f95c2ad000f40ea0c774cc1ced3a0ceb6f23/packages/react-reconciler/src/SchedulerWithReactIntegration.new.js#L131\">源码位置</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/84f4d/scheduler_call.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.799999999999997%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJklEQVQY022QW0vDQBSE8/9/jPiqeMEnpX0QrGCtF6zdjZu0qdlks0n39kmKikgHhuEc5gyHyWLdELuOoEe1GO3RW0dbe5rtgPeBESmlX/7Mh5B1WvMhc6pyTVUoSrXGbkqGYsXwWRGaithWxBR/j/6G/2dWa83j8wvVWuHkAzv5gFcLvJgRqndi3+BNi7c9ZhfxYQw+/N24z0xr6bsBFyBG8CHt7WGcXdqr6yOuC3Q9DEMiffu8j4SQcD7iXGBsIYs6x6k3xP0ly5sjxPSY4u6UfHpGPjmhmF2jhEStBKUUfI61SEEun5BigVwtKNUr9XZFcFsyZ9dEW2HFLXp+jn2+Qs8vaBaXNPMzmuWEzhTYrsC0it2w2as1Jb3dYJqC6GvAQNR8AbVpy5r5USwPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scheduler调用\"\n        title=\"Scheduler调用\"\n        src=\"/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/00d43/scheduler_call.png\"\n        srcset=\"/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/63868/scheduler_call.png 250w,\n/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/0b533/scheduler_call.png 500w,\n/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/00d43/scheduler_call.png 1000w,\n/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/84f4d/scheduler_call.png 1208w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n在使用Concurrent Mode的时候此处传入的callback是performConcurrentWorkOnRoot函数，这个函数是React内部调度更新的起始函数.</p>\n<p>以下是Scheduler_scheduleCallback的代码逻辑\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/67a79/schedule_callback.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 112.80000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAADIklEQVQ4y42V6W7cOBCE/RrJSBRJiaduaaSxxxd8rBf7/g/0LUQldgLbcX4UmoDIQnd1detC6BLlA815ZXw806wz7XnCtoH+YSXOA7qy+GFGV4Y8zxBCfIoLISXKOFw/Uq+X1OOIa2qklAhxIM8OZFlG9v0bebaT5Xn+OWEhBJUPDHfPjPcvhGnF1i1lWZHn7x/8iWwnLAoq64nLFe3lbSLbMsmy7DeSv8VFUWwZRrrrB/qbR9r1jIsxlSrEn7P5MENZCJquw3cTflywIWKso1AapaukZZ7lCSIXr/HzkpXGVQYTA7ZtqILH1AE/DYRpxDiLMpIy6D16jSzlh/omwlwqSmsY725pr8501zd012fqZaK/vaVZFqpQoZ1AlgJlJUIKssNhR3Z4bVQuci62gzWG4zwwrgvd1T3Nck3sJ+JwRBtPZSxV6Ci3c1kSg8PEBtP0SSKt9U6a/+hyUUhi9IynkfZ8ot+yPR3prhfCcaadGvzUYZtAPXiayeOGmjD3+KHBxBLtVJIlEW7CK6kwbSRMHWHsCFNPOI6EsU0PXg2eZRxSfF/yqw83OGs4nyamOdL3nmmuca4iFwcK9bVdfvHhTmitZ1xu8f0R9wN+XKlcQJqYbLTN8dbdjwz9k3QvuZDoSqOcQjuNNpoqlCluF7c7YsMXGf5WctM51nPP8dQyLw3Hq555aRnHmmmqccHj+gnfT5TWYdutIcfkBlkUb4SiENjKEkxMM3z49n0XfouHjDxlUHw502/rK8/xMXLz9MJ498Rw/0J3dUd3umG6e04ZxWnXcn9Y/FKmeKfphRIFqpS4psQPIS1WU1eY1uM6iyxzhMrQvkjnQmUJyhRor9BW7dGrNJpJQ6UUvvHEdcTPA2GZqC+PxHWmPk3UU5O+2bbDdWNaxpWpkGprlkgo5B73LouC/rhyevqX5eGZ9fGF0/N/LA//MJ4u6Y6XlNanzV66QOljSuIjXfcuS4l1JdFrvFUEv81rhbeaprG7wX+djsPhXTPe9qEQBBuwpUP7mtLX6WKW5WQ/Y5Z/6b9XQiUlRlcJpQ9pexefmPir/8lG+D+6pI2XBDmakQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scheduler调用callback\"\n        title=\"Scheduler调用callback\"\n        src=\"/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/00d43/schedule_callback.png\"\n        srcset=\"/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/63868/schedule_callback.png 250w,\n/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/0b533/schedule_callback.png 500w,\n/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/00d43/schedule_callback.png 1000w,\n/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/67a79/schedule_callback.png 1408w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n在unstable_scheduleCallback中主要做了如下几件事:</p>\n<ol>\n<li>根据传入的执行函数和优先级创建执行任务，加入异步执行队列或者同步执行队列</li>\n<li>调度任务更新</li>\n</ol>\n<p>以下先只关注同步taskQueue的执行流程,requestHostCallback通过Message channel发起宏任务来执行flushWork,最终走入到workLoop整个调度的<a href=\"https://github.com/facebook/react/blob/00d4f95c2ad000f40ea0c774cc1ced3a0ceb6f23/packages/src/forks/SchedulerDOM.js#L200\">实现逻辑</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 733px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/698bc99b2ece9e667db04ba2c3e361f0/00b70/workloop.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 131.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD9UlEQVRIx42Vy27dNhCGz1sEjSXxTlGi7jo+Olc79zRANl0UfYsWBYp20V374F8hyY6dxEG6+DEUIQ5n5p/5udFGYIKnOjTEqUfnAWUcNpTYvEBKSZokK9KELMsQQnyF+/2NNorpuOP46sR02jJOI/3xTHfzhtiPn37O7u13sFFS0bcT/e6CawaqqiBUNaHp8UW5/HQf3QPSb2IjhcDmOf76jN/dYPsJ2U648YirOvKiIHQjoe3J24G8atdL0vTpCKWShDygrScVklQqshnGIYxHSIXQdoE0FmXMGs23Up6LrpWm3R3pLm/ozi9pTi+J447heKS/HuinHdc3F8ZpjzWGJEm+cnQf8RKhMQYXAjZGfF3jmxrjHc4oiuDIvV2s0Zo0SZ/EvdPN3DZSKnxpCYPFd5py5/CdRVqB0ALp5GqtRFmJ9gqdK5STmKCWvYcI5RphWzTkzpOJFCEzhJydSTK5OhVKIB/ZT2uz2kcOBcYHhI+koUFWA9oHXGwp24EQK6phh/WB5OrqIc00u8O6/owUqy31/pb69gPx9Ip4+57hdENdN2zHLVUV0cYuzT2zPh9Mrp6TJFdLj84XLZctfSglUmuK6xP15S3V5R3V5S3x/Aa7PROmW6rdifb0kub4gvbyiridcLHBlxXW57hY46sWqRQbpQVKKeq2ZNw39IcR148U0558vMb3PXGaqHYTWmvUDGPR1i3npNJoly9lm8ldWVYa1/aUhx3l+UA8TFSnifK4p51adueG7alDVANp0SKKBhl7ZL3FOH9X2+QhZaU0sdsRj69x44nmsKI9X+jPN8S6pfSOGHLKEDA+J1NmnSApybKHMdxoK5BCorTCthWuqzFtjR86TF0g65rMBuQsaXO9vEeK7JGkPTT1EuFcB5EJuqHn8uqW/WXP9jDRnF5Q78/4cb8IR3F6Tdi/QIaK7ItZfiwUGy0lQkmaENkOW8qZkG4kL0qapqRqW0K/pahb7DJ6V3fO0icVZ9FDIeQyp23fUm6PVLsz1nqMlhhrUS5fmJ3FNn0iqs8dKrnQb/06u/MoKTfPbUaaJQ8MflGvbyu2EYt89dtqaY9hKmkOHdXxmri7Rt/pX/adyD45nNO11jD1A1XTkccapRxpki2lWNNM/9d7srA8H/Ah0I4jxfawCGtVx0UgbIgobR4JwiObfr13l7LF5gETI7Yssd5QtYHQtYRhiyvmHpRIo5B6tbOszZ2x7qnFrq+imEkROJMSWkveePLa4aPC1RofEqT6AVem2JCg3dWyNvm6nvfMbIuE7OoZ6fNnbOyPvxE//kX/8z/EX/6l/Olv8o9/4D7+if/wO+bdr+i3v6LffQ7z5ff7Ff8BGwXxHBeZuTwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"workLoop调用\"\n        title=\"workLoop调用\"\n        src=\"/blog/static/698bc99b2ece9e667db04ba2c3e361f0/00b70/workloop.png\"\n        srcset=\"/blog/static/698bc99b2ece9e667db04ba2c3e361f0/63868/workloop.png 250w,\n/blog/static/698bc99b2ece9e667db04ba2c3e361f0/0b533/workloop.png 500w,\n/blog/static/698bc99b2ece9e667db04ba2c3e361f0/00b70/workloop.png 733w\"\n        sizes=\"(max-width: 733px) 100vw, 733px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span><br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/0f586/yieldTimeout.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 92%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACs0lEQVQ4y4WU2W4cNxBF9RlG1NybO3ubGY2txWNY8Ev+/4NO0GxFseEkergokkAfXNYt9l2KEeUiqS2cHzY+P125XM+cdz1slJJxsWLdiBQC8YHuaq1IqQjTRn7+Rry9Mt5+UL488fT9kfOXE+enK/M6oaxCGoXUCm0USu+Sh+yxvvMxEoRg0gNTFMxRMgfBmgRbVX2/BMGSFFuznKthqhZbLb45xl3V4rJFGXUA0yAoKZJOE3GOjEvGLg3tPWOI+FIYU0Jbi5OCogSDlCgl312+XznXShzuyW3DXV4Qp0c+Xb/z6fINOV+IywO+rbiYkcaih4F0PzAI+VtPpZTcpZzx+5XVwDTuV9OsWbMEyZo00yhpZqDZgeYkq1dkr7HZYoPpMl53WHe4p7xvzKgPuaNab7pkd/KmQSCGN0fD7wl3hznnA+gUYzWMVffqksZlg58cLpmj+c3h57GfhWVkrK4H09fNHQ5LKQfQj5TrzHw7Ux4afor4OeFnh02mw8Ps8Hu6k+va0x2LwTeLtuoAxv3KQhBCJc0n/LQyxoIdPS5ErNGYNwltGbRFKIOQGiHVsdf2px6mhJSCGBOnyzPTdu2wWgLzlFmWQq2R1jKyLPzRTtzXE0OaECFzv9eyYIx5eymldvpoHcu0sT5/pTxcia0grUQogTT7S5Boc/S6y2u0U+j93Kq+7qEcT28fUtWbX7ZAOyema2b5XChrJFVPrB47mgPyNgkHUL3X7jCEcIRiDGub2OZGDI6SAyV78l5LIMWA0YZhGI6R+Rf9MjZaKebrC+fXP1luP5hfXpkeb4x1wbbzL7P2X/rpbyMZnUM7h/Wxp2t6ygltLMq6fz76H2B3uI+N1ppWZlIsB8AYlNbHx3pPb3h395HLA6gUPlfydiGtZ+JyIrSluzWxIJX6EPQ38C/i5f+uoA5LswAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"任务过期处理逻辑\"\n        title=\"任务过期处理逻辑\"\n        src=\"/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/00d43/yieldTimeout.png\"\n        srcset=\"/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/63868/yieldTimeout.png 250w,\n/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/0b533/yieldTimeout.png 500w,\n/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/00d43/yieldTimeout.png 1000w,\n/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/0f586/yieldTimeout.png 1498w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\nwookLoop是实现任务调用的核心逻辑,它主要实现了如下几件事:</p>\n<ol>\n<li>对可执行时间进行了切片(yieldInterval == 5ms)</li>\n<li>当超时可执行时间后,进行任务队列的调整在下个事件循环中唤起任务调度逻辑.这里有区分的是同步任务队列是直接通过postMessage发起调用,延迟任务队列是通过timer(setTimeout)发起调用.</li>\n</ol>\n<p>抛开源码可以简单的理解Scheduler的调度任务实现思路如下图,它正好实现了任务调度切片,优先级,高优任务插入等逻辑.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 984px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/d056dfc402ef23dd6cb937078e3b9073/f30f2/how_scheduler_work.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 99.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe9INAQKD//EABcQAAMBAAAAAAAAAAAAAAAAAAABIDH/2gAIAQEAAQUCFl//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/Ah//xAAaEAACAwEBAAAAAAAAAAAAAAABIQAQETFR/9oACAEBAAE/ITyelNuDcVGDlf/aAAwDAQACAAMAAAAQMwc8/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHBABAAICAwEAAAAAAAAAAAAAAQARITEQUWGB/9oACAEBAAE/EN1dRqHbhBk0fNTqPsLrNQYmPD//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scheduler整体的思路\"\n        title=\"Scheduler整体的思路\"\n        src=\"/blog/static/d056dfc402ef23dd6cb937078e3b9073/f30f2/how_scheduler_work.jpg\"\n        srcset=\"/blog/static/d056dfc402ef23dd6cb937078e3b9073/0479a/how_scheduler_work.jpg 250w,\n/blog/static/d056dfc402ef23dd6cb937078e3b9073/41099/how_scheduler_work.jpg 500w,\n/blog/static/d056dfc402ef23dd6cb937078e3b9073/f30f2/how_scheduler_work.jpg 984w\"\n        sizes=\"(max-width: 984px) 100vw, 984px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>参考链接</h2>\n<p><a href=\"https://engineering.fb.com/2019/04/22/developer-tools/isinputpending-api/\">isInputPending的实现背景</a><br>\n<a href=\"https://web.dev/isinputpending/\">isInputPending的使用思路</a><br>\n<a href=\"https://someu.github.io/2020-11-10/react-scheduler%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/\">react scheduler源码解析</a><br>\n<a href=\"https://react.iamkasong.com/concurrent/scheduler.html#%E6%97%B6%E9%97%B4%E5%88%87%E7%89%87%E5%8E%9F%E7%90%86\">React技术解密</a></p>","fields":{"readingTime":{"text":"5 min read"}},"frontmatter":{"title":"从Scheduler包来看React的任务调度","date":"2021-03-15","tags":"React","path":"/react-scheduler","top":null,"summary":null}}},{"node":{"id":"76e654f7-5c52-5b12-8d13-55f5aa101acc","html":"<p>最近公司组织架构调整，来字节的一年多时间难得有这样一段清闲的时光来思考下自己这段时间做的事，坐在电脑旁想用一句简短的话来总结下这一年，想了半个小时愣是没想出来。所以还是以片段的方式来思考下2020一些做的不好点的，希望2021这个新年能做的更好。</p>\n<h3>技术能力</h3>\n<ol>\n<li>从原来的B端业务场景比较快速的熟悉了C端Hybrid项目的开发流程。对于跨端开发的知识的深入度不够。</li>\n<li>快速处理问题的能力有提升</li>\n<li>业务实现设计思考比较欠缺，在忙于业务的时候并没有思考好业务代码的组织形式和方案。</li>\n</ol>\n<h3>业务理解</h3>\n<ol>\n<li>低头看的时间比较多，没有看的更宽或者从业务的视角看的更远。</li>\n<li>没有更好的从业务的视角去思考技术，导致从开发视角看一直在实现PM的各种业务，没有一个长期的技术路径视角。</li>\n</ol>\n<h3>管理协作</h3>\n<ol>\n<li>没有把握好自身的精力。有时候会压缩自己在短时间内做更多相对简单重复的事，而不是压缩自己做超出自己能力的事。</li>\n<li>原则性不够  需要意识到良好的规则能更好的让事情发展，应该与协作方一起建立规则，否则会导致自己疲于奔命得到的事情的结果不一定是正向的。举个例子：需求排期的时候会估算需求的测试时间，如果一味的为了赶时间点，去压缩这个测试时间，就可能导致下个需求跟这个需求同时出现问题。保证一件事做好有可能真的不比两件事做完差(自身成长+ 业务价值)</li>\n</ol>\n<h3>2021的一些小目标</h3>\n<ul>\n<li>在技术和业务上希望自己能小步慢走，踏踏实实，走几步回头看看。不是一味的低头快走。</li>\n<li>自身学习上多看一些书，给自己的笨脑瓜充电点。体重上要控制住自己的嘴，减重年度okr: 10KG。</li>\n</ul>\n<p>结尾附录一段看到的话，共勉</p>\n<p>当我们提，技术驱动业务的时候，我们说的是：“我们已经想清楚业务的目标是什么，知道技术能在其中起到什么作用，目前现状是什么，我们可以怎么做，并且每个双月都定期复盘和回顾。”\n当我们提，我们这个方向好缺人，里面隐含着：“我们知道长期这个方向要解决哪些问题，目标是什么，需要招什么样的人，招来做什么？”\n当我们问，如何才能在技术上走到下一个阶段？除了执行力和自驱力之外，想清楚规划和执行路径，也是很关键的一步。</p>","fields":{"readingTime":{"text":"4 min read"}},"frontmatter":{"title":"2020年总结","date":"2021-02-01","tags":"年度总结","path":"/2020-summary","top":null,"summary":null}}},{"node":{"id":"a75da308-1935-501a-8291-43665a2911c1","html":"<h2>概要</h2>\n<p>本文主要梳理前端路由的实现方案，按照如下的逻辑进行梳理：\n前置知识 => 路由方案现状 => 从源码的解读理解前端路由的实现过程</p>\n<h2>前置知识</h2>\n<h3>history</h3>\n<table>\n<thead>\n<tr>\n<th>方法(属性)</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>history.length</td>\n<td>只读, 代表当前会话历史的长度</td>\n</tr>\n<tr>\n<td>history.state</td>\n<td>只读, 代表当前会话栈顶的state</td>\n</tr>\n<tr>\n<td>history.go(number) history.forward() history.back()</td>\n<td>从当前会话加载特定的页面,会触发popstate事件</td>\n</tr>\n<tr>\n<td>pushState(state, title, url)</td>\n<td>在当前会话的添加一个新的记录(关联state) url参数需要保证同源策略</td>\n</tr>\n<tr>\n<td>replaceState(state, title, url)</td>\n<td>替换当前会话栈顶的记录(不会增加history长度,关联state) url参数需要保证同源策略</td>\n</tr>\n</tbody>\n</table>\n<h4>history相关事件</h4>\n<p>当用户触发浏览器动作或者js调用history.back/history.forward/history.go方法时,会触发popstate事件。</p>\n<h3>hash相关事件</h3>\n<ol>\n<li>当url片段标识符改变(#xxx), 会触发hashchange事件。</li>\n<li>当设置与当前不同的hash片段的时候，会在当前会话中添加一个新的记录。</li>\n</ol>\n<h2>路由方案现状</h2>\n<table>\n<thead>\n<tr>\n<th>方案</th>\n<th>原理</th>\n<th>优缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>基于history实现的路由方案</td>\n<td>使用history相关事件和方法完成路由的切换</td>\n<td>history可以设置同源下的任意url，需要注意与服务端结合的场景，防止出现404</td>\n</tr>\n<tr>\n<td>基于hash实现的路由方案</td>\n<td>使用hash相关事件完成路由的切换</td>\n<td>hash只能改变当前url的#，有局限性</td>\n</tr>\n</tbody>\n</table>\n<h2>从源码的了解路由的实现过程</h2>\n<p>以下源码分析了history路由的实现过程,源码涉及<a href=\"https://github.com/ReactTraining/history\">history</a>, <a href=\"https://github.com/ReactTraining/react-router\">react-router</a>.整体的实现逻辑如下</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 424px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/b70462c5399fc0b238df6097205f72be/1cfa9/route.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 172%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAiCAYAAABfqvm9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC8UlEQVRIx62W6U5yMRCGuf/rIPzgF3dgQgCDyCIoyL7JjrKobAo1zyRz0gOFD83XZNKeLtN3+r6dnsB2uzVfX19ms9mY9XottRrfjO92O6/+lwW+v7/NaDQytVrNtFot02w2PeP7+fnZfHx8yKbXOA3s93tZDCJX6ff7ZjabGTa+2mG73ZbwDoeDmc/n4uDz8/P/OHx5eZHwB4PB3x0SMpNdBcdvb28+h9TnyBJShsOhoAJpo9Ew8XhcCOl2u6ZcLgspbGw7OEdSQDtXq5UQ8/r6akKhkHl/f5dQF4uFtDHGmUvNJk6Ex53s3Ov15OwymYxJp9MmkUhI/fT0ZKrVqle7ztVDyCBhsXsul/NNBg2hwzzkEQ31WYQMTqdTCZFzDAaD0qYPQpiDs+PFzjNU2UDAeDwWgyQMh6VSSbTJPGX3IstMhFHOzlW4lsc6vKRHcdjpdIRdkNIGGdoENUIH4Z9uihqLNSG4EF51U1iIE3QHImqIqFQqv3MICkSL7tTQn/19TiJOh5pgSQygpXButLXvVwnWztjUkBOJRLw+W3O2MeaSkCSHyWTisUpyuLm5Ebb55opxtsxT00g0CjsCIQUny+XSm0BhIQUFQBJO2RgjpdXrdakZhzzNPp5s9AmAXe4qpvmQzbhBJAXu9MPDg7m/v5c2NeOqAp8OtQ1iwqWQediEq8g1BBnJ4/HxUdr0oQQfQs4Ph+cyNmFyPdmIVzCVSokVCgVxWiwW/aSwyH5G2Z0atExGp4pAVcE6zZ929g643gmQqCyOZeOSkE829hNAm8MPh8PShj3VosuJaxPvz4GzIETqWCwm4fPNmWnImtlVixq2D+E1zyjJAX1qZkcmEEU0RGAnjpOHnpSPA4RsP/QswBGIIQrpZLNZkZX9Ap44BBGkoDt1yCZcRdhHdzjN5/MmGo2a29tbEfhJyJd+lrh6jPMDcHd3JxrkWU0mk/LEcgzeTTn+nQOdGshBZOvw+NWz5eXJ5rc/nK7cqKT8ABAkKsYiO95UAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"route\"\n        title=\"route\"\n        src=\"/blog/static/b70462c5399fc0b238df6097205f72be/1cfa9/route.png\"\n        srcset=\"/blog/static/b70462c5399fc0b238df6097205f72be/63868/route.png 250w,\n/blog/static/b70462c5399fc0b238df6097205f72be/1cfa9/route.png 424w\"\n        sizes=\"(max-width: 424px) 100vw, 424px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>下面代码是在react项目中使用history路由实现的一个例子，它能实现根据特定的path来渲染对应的组件。</p>\n<pre><code>import './App.css';\nimport React from 'react'\nimport {\n  BrowserRouter as Router,\n  Switch,\n  Route,\n} from \"react-router-dom\";\nfunction App() {\n  return (\n    &#x3C;Router >\n      &#x3C;Switch>\n        &#x3C;Route exact path=\"/\">\n            &#x3C;div>home&#x3C;/div>\n          &#x3C;/Route>\n          &#x3C;Route path=\"/about\">\n            &#x3C;div>about&#x3C;/div>\n          &#x3C;/Route>\n          &#x3C;Route path=\"/dashboard\">\n            &#x3C;div>dashboard&#x3C;/div>\n          &#x3C;/Route>\n      &#x3C;/Switch>\n    &#x3C;/Router>\n  );\n}\nexport default App;\n</code></pre>\n<p>react-router/packages/react-router-dom/modules/BrowserRouter.js</p>\n<pre><code>import React from \"react\";\nimport { Router } from \"react-router\";\nimport { createBrowserHistory as createHistory } from \"history\";\n\nclass BrowserRouter extends React.Component {\n  history = createHistory(this.props);\n\n  render() {\n    // 初始化browser history 可以推断出路由的切换逻辑是history与Router结合的实现\n    return &#x3C;Router history={this.history} children={this.props.children} />;\n  }\n}\nexport default BrowserRouter;\n</code></pre>\n<p>packages/index.ts</p>\n<pre><code>// 在最后执行跳转的时候 会执行所有的listen函数\nfunction applyTx(nextAction: Action) {\n  action = nextAction;\n  [index, location] = getIndexAndLocation();\n  listeners.call({ action, location });\n}\nlet history: BrowserHistory = {\n  // 以下为主要的跳转函数，在实现跳转逻辑的时候都调用了applyT方法。\n  push,\n  replace,\n  go,\n  back() {\n    go(-1);\n  },\n  forward() {\n    go(1);\n  },\n  // listion方法用于增加路由切换的监听函数\n  listen(listener) {\n    return listeners.push(listener);\n  },\n  // block方法允许传入一个block函数,在路由跳转的时候会执行所有的blocker函数\n  block(blocker) {\n    let unblock = blockers.push(blocker);\n    if (blockers.length === 1) {\n      window.addEventListener(BeforeUnloadEventType, promptBeforeUnload);\n    }\n    return function() {\n      unblock();\n      if (!blockers.length) {\n        window.removeEventListener(BeforeUnloadEventType, promptBeforeUnload);\n      }\n    };\n  }\n};\nreturn history;\n</code></pre>\n<p>从上面history源码看出，history这个库主要是维护history的相关状态(state, location, hash)并且增加路由跳转的告知能力.</p>\n<p>react-router/packages/react-router/modules/Router.js</p>\n<pre><code>import React from \"react\";\nimport HistoryContext from \"./HistoryContext.js\";\nimport RouterContext from \"./RouterContext.js\";\nclass Router extends React.Component {\n  static computeRootMatch(pathname) {\n    return { path: \"/\", url: \"/\", params: {}, isExact: pathname === \"/\" };\n  }\n  constructor(props) {\n    super(props);\n    this.state = {\n      location: props.history.location\n    };\n    this._isMounted = false;\n    this._pendingLocation = null;\n    if (!props.staticContext) {\n      // 这里订阅了history的变化并且在变化的之后更新location\n      this.unlisten = props.history.listen(location => {\n        if (this._isMounted) {\n          this.setState({ location });\n        } else {\n          this._pendingLocation = location;\n        }\n      });\n    }\n  }\n  componentDidMount() {\n    this._isMounted = true;\n    if (this._pendingLocation) {\n      this.setState({ location: this._pendingLocation });\n    }\n  }\n  render() {\n    return (\n      // 将location作为context 在需要订阅的位置获取   Route消费location完成特定children的渲染。\n      &#x3C;RouterContext.Provider\n        value={{\n          history: this.props.history,\n          location: this.state.location,\n          match: Router.computeRootMatch(this.state.location.pathname),\n          staticContext: this.props.staticContext\n        }}\n      >\n        &#x3C;HistoryContext.Provider\n          children={this.props.children || null}\n          value={this.props.history}\n        />\n      &#x3C;/RouterContext.Provider>\n    );\n  }\n}\nexport default Router;\n</code></pre>","fields":{"readingTime":{"text":"5 min read"}},"frontmatter":{"title":"聊聊前端的路由方案","date":"2020-12-15","tags":"JavaScript","path":"/history","top":null,"summary":null}}},{"node":{"id":"be69e5b2-aefc-53f5-a712-d24f2d40c7ba","html":"<h2>为什么开启设计模式系列</h2>\n<p>在业务压力下，仓库的代码量是快速增长的。最近在思考如何能让代码有灵活性和扩展性。随着产品的迭代，一部分业务逻辑需要重新实现，那一种良好的设计是否能在重构代码中帮助我们呢？答案是确定的。开启这个系列主要有这两方面的原因:</p>\n<ol>\n<li>在翻译业务的时候更高效和优雅</li>\n<li>通过对模式的学习能加强思考</li>\n</ol>\n<p>设计模式是解决一类问题的通用的方案，希望通过对设计模式的学习能完善解决问题的能力，本系列会结合《设计模式-可复用面向对象软件的基础》来对设计模式进行比较全面的梳理。</p>\n<h2>创建型模式</h2>\n<p>创建型模式通过对实例化过程进行抽象，隐藏了底层的具体实现，从而实现更多的灵活性。创建型模式有以下几种:</p>\n<ol>\n<li>Abstract Factory(抽象工厂)</li>\n<li>Builder(生成器)</li>\n<li>Factory Method(工厂方法)</li>\n<li>Prototype(原型)</li>\n<li>Singleton(单例)</li>\n</ol>\n<p>本文会结合一个创建迷宫的示例来介绍以上几种设计模式.通常实现一个迷宫会定义以下基类:</p>\n<pre><code>// 方向枚举\nenum Direction { North, South, East, West };\n// 迷宫组件的公用抽象类\nclass MapSite {\n  public: virtual void Enter() = 0;\n}  \n// 房间  保存其他MapSite的引用\nclass Room: public MapSite {\n  public: \n    Room(int roomNo);\n    MapSite* GetSide(Direction) const;\n    void SetSide(Direction, MapSite*)\n  private:\n    MapSite* _sides[4];\n    int _roomNumber;\n}  \n// 墙 \nclass Wall : public MapSite {\n  public: \n    Wall();\n    virtual void Enter();\n}\n// 门\nclass Door : public MapSite {\n  public: \n    Door(Room* = 0, Room*  = 0);\n    virtual void Enter();\n    Room* OthersSideFrom(Room*);\n  private: \n    Room* _room1;\n    Room* _room2;\n    bool _isOpen;\n}\n// 迷宫类\nclass Maze {\n  public: \n    Maze();\n    // 在迷宫中添加Room\n    voidb AddRoom(Room *);\n    // 根据RoomNo查找Room\n    Room* RoomNo(int) const;\n  private:\n}\n// 一个可能的迷宫生成代码\nMaze* MazeGame::CreateMaze() {\n  Maze* aMaze = new Maze();\n  Room* r1 = new Room();\n  Room* r2 = new Room();\n  Door* theDoor = new Door(r1,r2);\n  aMaze->AddRoom(r1);\n  aMaze->AddRoom(r2);\n  r1.SetSide(North, new Wall);\n  r2.SetSide(North, new Wall);\n  // 省略很多的SetSide操作\n  return aMaze\n}\n</code></pre>\n<p>上面代码在定义迷宫布局的时候对布局过程进行了硬编码，在未来需要对迷宫布局进行修改的时候就需要修改硬编码逻辑。通过创建型模式可以实现将实现的细节封装起来，给予代码一定的可变化性。</p>\n<h3>Abstract Factory(抽象工厂) - 对象创建型模式</h3>\n<p>抽象工厂提供一个创建一系列相关或相互依赖对象的接口而无需指定他们具体的类。</p>\n<h4>结构</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 891px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e80d271562927a69d5fe496b8b2a10a7/b7877/abstractFactory.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.599999999999994%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABK0lEQVQoz41S147DMAzL//9gkYHMZu80O01UkAcd0ocDToBgW5ZpkrYhInJdl7zfb9n3XZZlkW3buP5v4LyGoYWqqsT3fXk8HuK6rqRpKl3XyXEcvACX6fh6vbjfNA3376CGTnA4CAI2Pp9P5rqu3APb8zyZiGmaSKBt2y8lwCJDNCoT3cAazfcDd1t0Pc8ze/UyoyxLSjVNkwyLoqCUMAzFsixxHEeSJKHMKIq4hiUIMLRtm7W6rn8AIc3zPAIAGIcAeq9hDkAo6Puec2U4jiNrYP77KGhUc++ButoAmQCHd/A5jmPOcRkIQB1Y8lHQjFTP9BHgDx5Ae/I8p0wkQIZhkCzLOOqagGr0PcEMLw8/AYzUOkZcBFUq9UvyXwGmCoIvpKk1BVRr8G0+DjIE5/TLV5AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"抽象工厂结构\"\n        title=\"抽象工厂结构\"\n        src=\"/blog/static/e80d271562927a69d5fe496b8b2a10a7/b7877/abstractFactory.png\"\n        srcset=\"/blog/static/e80d271562927a69d5fe496b8b2a10a7/63868/abstractFactory.png 250w,\n/blog/static/e80d271562927a69d5fe496b8b2a10a7/0b533/abstractFactory.png 500w,\n/blog/static/e80d271562927a69d5fe496b8b2a10a7/b7877/abstractFactory.png 891w\"\n        sizes=\"(max-width: 891px) 100vw, 891px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>AbstractFactory</li>\n</ul>\n<p>声明一个创建抽象产品对象的操作接口</p>\n<ul>\n<li>ConcreteFactory</li>\n</ul>\n<p>实现创建具体产品对象的操作</p>\n<ul>\n<li>AbstractProduct</li>\n</ul>\n<p>为一类产品对象声明接口</p>\n<ul>\n<li>ConcreteProduct</li>\n</ul>\n<p>定义一个将被相应具体工厂创建的产品对象，实现AbstractProduct接口</p>\n<ul>\n<li>Client</li>\n</ul>\n<p>仅使用由AbstractFactory和AbstractProduct类声明的接口</p>\n<h4>适用性</h4>\n<p>抽象工厂通过将具体的对象创建延迟到ConcreteFactory中，能提供丰富的灵活性，适用于以下场景:</p>\n<ol>\n<li>一个系统要独立于它的产品的创建，组合和表示时</li>\n<li>一个系统要由多个产品系列中的一个来配置时</li>\n<li>需要对一系列相关产品对象设计进行联合使用时</li>\n<li>对外提供产品类库，提供统一的接口</li>\n</ol>\n<h4>优点&#x26;缺点</h4>\n<ul>\n<li>分离了具体类的实现，通过具体工厂封装对具体产品实现的细节。</li>\n<li>通过具体工厂的实现，将具体产品的实现逻辑封装在一起，增加了整体的一致性。但是在增加新的种类的产品的时候需要实现新的具体工厂。</li>\n</ul>\n<h4>代码示例</h4>\n<p>下面的代码使用Abstract Factory模式来创建一个迷宫。</p>\n<pre><code>// 定义抽象方法类\nclass MazeFactory {\n  public: \n    MazeFactory()\n  \n  virtual Maze* MakeMaze() const { return new Maze; }\n  virtual Wall* MakeWall() const { return new Wall; }\n  virtual Room* MakeRoom(int n) const { return new Room(n); }\n  virtual Door* MakeDoor(Room* r1, Room* r2) { return new Door(r1, r2); }\n}\n// 通过传递具体的工厂实现迷宫的创建\nMaze* MazeGame::CreateMaze(MazeFactory&#x26; factory) {\n  Maze* aMaze = factory.MakeMaze();\n  Room* r1 = factory.MakeRoom(1);\n  Room* r2 = factory.MakeRoom(2);\n  Door* aDoor = factory.MakeDoor(r1, r2);\n  aMaze->AddRoom(r1);\n  aMaze->AddRoom(r2);\n  \n  r1.SetSide(North, factory.MakeWall())\n  r2.SetSide(North, factory.MakeWall());\n  // 省略很多的SetSide操作\n  return aMaze;\n} \n\n// 创建过程\nMazeGame game;\nMazeFactory factory\ngame.CreateMaze(factory)\n</code></pre>\n<p>通过传递ConcreteFactory,上面的代码将创建逻辑都封装在具体工厂中，这样通过传递不同的工厂就能完成不同类型对象的创建。</p>\n<h3>Builder(生成器) - 对象创建型模式</h3>\n<p>将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以创建不同的表示。Builder模式能更好的封装产品的内部表示。</p>\n<h4>结构</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 871px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/490bd2e7f7396de6958c32afdb0388ba/953da/builder.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAEDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHuTSRRX//EABcQAQADAAAAAAAAAAAAAAAAAAEAICH/2gAIAQEAAQUCBg7T/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bh//EABUQAQEAAAAAAAAAAAAAAAAAACAx/9oACAEBAAY/Aqv/xAAYEAEBAQEBAAAAAAAAAAAAAAABABEhEP/aAAgBAQABPyED3cSusO+EX//aAAwDAQACAAMAAAAQpA//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAwEBPxCn/8QAFhEAAwAAAAAAAAAAAAAAAAAAECEx/9oACAECAQE/EEg//8QAGxAAAwACAwAAAAAAAAAAAAAAAAERMVEQIYH/2gAIAQEAAT8QqGJomDZtdCEqvvGTMD//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"生成器结构\"\n        title=\"生成器结构\"\n        src=\"/blog/static/490bd2e7f7396de6958c32afdb0388ba/953da/builder.jpg\"\n        srcset=\"/blog/static/490bd2e7f7396de6958c32afdb0388ba/0479a/builder.jpg 250w,\n/blog/static/490bd2e7f7396de6958c32afdb0388ba/41099/builder.jpg 500w,\n/blog/static/490bd2e7f7396de6958c32afdb0388ba/953da/builder.jpg 871w\"\n        sizes=\"(max-width: 871px) 100vw, 871px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>Builder</li>\n</ul>\n<p>为创建一个Product对象的各个部件指定抽象接口</p>\n<ul>\n<li>ConcreteBuilder</li>\n</ul>\n<p>实现Builder的接口来完成对象的创建\n定义并明确它所创建的表示\n提供一个检索产品的接口</p>\n<ul>\n<li>Director</li>\n</ul>\n<p>构建一个使用Builder的接口对象</p>\n<ul>\n<li>Product</li>\n</ul>\n<p>被构造的复杂对象</p>\n<p>抽象的Builder类为Director要创建的对象定义操作。ConcreteBuilder实现Builder定义的方法</p>\n<h4>适用性</h4>\n<p>通过生成器可以把复杂的对象创建过程隐藏，通过不同的Builder来完成系统的创建, 适用于以下场景：</p>\n<ol>\n<li>当创建复杂对象的算法应该独立于该对象的组成部分以及它们的装配方式时</li>\n<li>当构造过程必须允许被构造的对象有不同的表示时</li>\n</ol>\n<h4>示例代码</h4>\n<pre><code>class MazeBuilder {\n  public:\n    virtual void BuildMaze() {};\n    virtual void BuildRoom(int room) {};\n    virtual void BuildDoor(int roomFrom, int roomTo) {};\n    virtual Maze* GetMaze() { return 0  };\n  protected: \n    MazeBuilder();\n}\n// 在具体调用的时候 可以传递一个实现了抽象类builder的ConcreteBuilder\nMaze* MazeGame::CreateMaze(MazeBuilder&#x26; builder) {\n  builder.BuildMaze();\n  builder.BuildRoom(1);\n  builder.BuildRoom(2);\n  builder.BuildDoor(1,2);\n  return builder.GetMaze();\n}\n\n// 创建过程\nMaze* maze\nMazeGame game\nMazeBuilder builder\nmaze = game.CreateMaze(builder)\n</code></pre>\n<p>对比抽象工厂,Builder模式封装了创建过程的细节，通过不同的builder实现可以创建出不同的对象。</p>\n<h3>Factory Method(工厂方法) - 对象创建型模式</h3>\n<p>工厂方法定义一个用于创建对象的接口，让子类来实现对应的接口来创建对象。Factory Method使一个类的实例化延迟到其子类。</p>\n<h4>结构</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 818px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/4abb3f8897249fdbe81056e7e9397567/64d87/factoryMethod.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABdUlEQVQoz5XRwY6DIBAG4L7/g/XQSisJcTSgoIK12GqtgDXadlPd3Zi97XeawPwBhs00TcYYa61zbhgG55yZTdP0/tH3fdd1fd8/Hg9rbdd1y+6mKAohhNaac04IWWo5m6bpMWOMaa0ZY0EQFEWRpmlZlp8w5/x0Oo3jqJTCGOd5boxpmoZS2vf9/X5vmuZ4PDZNQwjxPE8pJYSI4/g7jDEmhPi+DwBKqSzLktly59frxRiL45hzDgBZlgFAVVWf8HKg7/sIoe12myRJnudJkiilluTvy8dxbNt2vbh5rxhj1t1/PJ9P59x6ZWOt1VrXs/P5vBRa63Xf9Xqt67qqKinl7XbTWltrP2EhhJQSAA6HA0Jot9uFYXi5XBhjbduWZVnXte/7QRAghPb7ved5GGMp5ffAOOdpmgJAGIZxHAsh8jynlI4zYwxCiFK6NERRhDEWQnzCZVkCQBRFABAEAWOMUkoIWX5yYX+4Wdd1wzD8Hdh/fQFNImIPdtdAXwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"工厂方法\"\n        title=\"工厂方法\"\n        src=\"/blog/static/4abb3f8897249fdbe81056e7e9397567/64d87/factoryMethod.png\"\n        srcset=\"/blog/static/4abb3f8897249fdbe81056e7e9397567/63868/factoryMethod.png 250w,\n/blog/static/4abb3f8897249fdbe81056e7e9397567/0b533/factoryMethod.png 500w,\n/blog/static/4abb3f8897249fdbe81056e7e9397567/64d87/factoryMethod.png 818w\"\n        sizes=\"(max-width: 818px) 100vw, 818px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>Product</li>\n</ul>\n<p>定义工厂方法所创建对象的接口(抽象产品)</p>\n<ul>\n<li>ConcreateProduct</li>\n</ul>\n<p>实现Product的接口(具体产品)</p>\n<ul>\n<li>Creator</li>\n</ul>\n<p>声明工厂方法(抽象工厂)</p>\n<ul>\n<li>ConcreteCreator</li>\n</ul>\n<p>实现工厂方法，返回ConcreateProduct实例</p>\n<p>工厂方法依赖它的子类来实现工厂方法来完成对象的创建。</p>\n<h4>适用性</h4>\n<p>工厂方法适用于以下场景:</p>\n<ol>\n<li>父类不知道它需要创建的对象的类的时候</li>\n<li>当一个类希望它的子类来指定创建对象的时候</li>\n<li>当类将创建对象的职责委托给多个帮助子类中的某一个并且希望某一个帮助子类代理这个创建过程</li>\n</ol>\n<h4>示例代码</h4>\n<pre><code>class MazeGame {\n  public: \n    Maze* CreateMaze();\n\n    // factory method;\n    virtual Maze* MakeMaze() const { return new Maze(); };\n    virtual Room* MakeRoom(int n ) const { return new Room(n); };\n    virtual Wall* MakeWall() const { return new Wall; };\n    virtual Door* MakeDoor(Room* r1, Room* r2) const { return new Door(r1,r2);  };  \n}\n\nMaze* MazeGame::CreateMaze() {\n  Maze* aMaze = new Maze();\n  Room* r1 = new Room();\n  Room&#x26; r2 = new Room();\n  Door* theDoor = new Door(r1,r2);\n  aMaze->AddRoom(r1);\n  aMaze->AddRoom(r2);\n  r1.SetSide(North, new Wall);\n  r2.SetSide(North, new Wall);\n  // 省略很多的SetSide操作\n  return aMaze\n}\n// 子类实现工厂方法来完成对象的创建\nclass BombedMazeGame : public MazeGame {\n  public:\n    BombedMazeGame()\n    virtual Room* MakeRoom(int n) const  { return new RoomWithBomb(n); };\n}\n</code></pre>\n<h3>PROTOTYPE（原型) - 对象创建型模式</h3>\n<p>原型模式通过原型实例指定创建对象的种类，通过拷贝原型来创建新的对象</p>\n<h4>结构</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 747px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/248deee1cdd58b5c46a8d268e9521388/d54e4/prototype.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQY03XQ224EIQiA4Xn/x5wLKzr1iA6guG3cbA9p+l0S/pBw1FpjjABQSqm1Pl7GGMwsGxGFEGKMPyeqepznaYwJIVzXZa3tvRMRM8cYvfcppbC9bYhYa0XElNIY40gplVJ67601Zv66rKrMXEpBRGaem6q21u77VtW11vFcXWs9fltriQgiEpGIrI2Z28bM3/FfRAQA1loAcM6NMUTEGOOcs9uc89+Ymb33Oef3bc4pIgCQc34+6DP+AFoUWqjoiPwWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"原型方法\"\n        title=\"原型方法\"\n        src=\"/blog/static/248deee1cdd58b5c46a8d268e9521388/d54e4/prototype.png\"\n        srcset=\"/blog/static/248deee1cdd58b5c46a8d268e9521388/63868/prototype.png 250w,\n/blog/static/248deee1cdd58b5c46a8d268e9521388/0b533/prototype.png 500w,\n/blog/static/248deee1cdd58b5c46a8d268e9521388/d54e4/prototype.png 747w\"\n        sizes=\"(max-width: 747px) 100vw, 747px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>Prototype</li>\n</ul>\n<p>声明一个克隆自身的接口</p>\n<ul>\n<li>ConcretePrototype</li>\n</ul>\n<p>实现一个克隆自身的操作</p>\n<ul>\n<li>Client</li>\n</ul>\n<p>让一个原型克隆自身从而创建一个新的对象</p>\n<h4>适用性</h4>\n<p>原型模式适用于以下场景:</p>\n<ol>\n<li>实例化的类需要在运行时刻指定</li>\n<li>类的实例状态是相似的，通过原型的克隆能减少类的创建</li>\n</ol>\n<h4>示例代码</h4>\n<pre><code>class MazePrototypeFactory : public MazeFactory {\n  public :\n    MazePrototypeFactory(Maze* , Wall*, Room*, Door*);\n\n    virtual Maze* MakeMaze() const;\n    virtual Room* MakeRoom(int) const;\n    virtual Wall* MakeWall() const;\n    virtual Door* MakeDoor(Room*, Room*) const;\n\n  private:\n    Maze* _prototypeMaze;\n    Room* _prototypeRoom;\n    Wall* _prototypeWall;\n    Door* _prototypeDoor;\n}\n\nMazePrototypeFactory::MazePrototypeFactory (\n  Maze* m, Wall* w, Room* r,Door* d\n) {\n  _prototypeMaze = m;\n  _prototypeRoom = r;\n  _prototypeWall = w;\n  _prototypeDoor = d;\n}\n\nWall* MazePrototypeFactory::MakeWall() const {\n  return _prototypeWall->Clone();\n}\nMazeGame game;\n// 需要初始化传入的实例支持clone操作，可以通过传递不同的实例完成不同的对象创建\nMazePrototypeFactory simpleMazeFactory(new Maze, new Wall, new Room, new Door);\nMaze* maze = game.CreateMaze(simpleMazeFactory)\n</code></pre>\n<h3>SINGLETON（单例）- 对象创建型模式</h3>\n<p>保证一个类仅有一个实例，并提供一个访问他的全局访问点</p>\n<h4>结构</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/03abfaad5a513dba67caa9b1bc031dc5/acb04/singleton.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdu6QD//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAEFAl//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAaEAACAgMAAAAAAAAAAAAAAAAAARARIUFR/9oACAEBAAE/IVnbLE7KXJ//2gAMAwEAAgADAAAAENDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAIDAQAAAAAAAAAAAAAAAQARECExkf/aAAgBAQABPxB7NzXBiTW+QRKuDzP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"单例模式\"\n        title=\"单例模式\"\n        src=\"/blog/static/03abfaad5a513dba67caa9b1bc031dc5/acb04/singleton.jpg\"\n        srcset=\"/blog/static/03abfaad5a513dba67caa9b1bc031dc5/0479a/singleton.jpg 250w,\n/blog/static/03abfaad5a513dba67caa9b1bc031dc5/41099/singleton.jpg 500w,\n/blog/static/03abfaad5a513dba67caa9b1bc031dc5/acb04/singleton.jpg 750w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>Singleton</li>\n</ul>\n<p>定义一个Instance操作，允许客户访问它的唯一实例</p>\n<h4>适用性</h4>\n<p>单例模式适用于以下场景:</p>\n<ol>\n<li>唯一的实例需要全局访问时</li>\n</ol>\n<h4>示例代码</h4>\n<pre><code>class Singleton {\n  public: \n    static Singleton* Instance();\n  protected:\n    Singleton();\n  private:\n    static Singleton* _instance;\n}\n\nSingleton* Singleton::_instance = 0;\n// 对成员初始化未空，第一次访问的时候创建成员，再次访问直接范返回成员\nSingleton* Singleton::Instance() {\n  if(_instance == 0) {\n    _instance = new Singleton();\n  }\n  return _instance;\n}\n</code></pre>\n<p>在单例模式中，想要实现动态的确定单例的类型方式，可以通过维护单例注册表的方式来实现。</p>","fields":{"readingTime":{"text":"13 min read"}},"frontmatter":{"title":"编程拾遗系列设计模式-创建型模式","date":"2020-07-06","tags":"设计模式","path":"/build-pattern","top":null,"summary":null}}}],"pathPrefix":"","first":false,"last":false,"index":10,"pageCount":15,"additionalContext":{"pageAllCount":88}}},"staticQueryHashes":[]}