{"componentChunkName":"component---src-templates-post-js","path":"/axios-cancel","result":{"data":{"markdownRemark":{"html":"<p>本文梳理axios中使用CancelToken来实现中断请求的源码实现.\n(CancelToken已经是deprecated, axios已支持AbortController实现相应的功能)</p>\n<h2>简单使用</h2>\n<pre><code>    const CancelToken = axios.CancelToken;\n    // 创建cancelToken\n    const source = CancelToken.source();\n\n    axios.get('/user/12345', {\n        // 请求的时候 传入创建的cancelToken\n        cancelToken: source.token\n    }).catch(function (thrown) {\n        if (axios.isCancel(thrown)) {\n            console.log('Request canceled', thrown.message);\n        } else {\n            // handle error\n        }\n    });\n\n\n    // 调用cancelToken的cancel方法 取消请求\n    source.cancel('Operation canceled by the user.');\n</code></pre>\n<p>上面是axios官网的上使用CancelToken的例子，可以看到通过将创建的cancelToken传入对应的请求对象，就实现了请求控制能力暴露给外部的能力。</p>\n<h2>源码分析</h2>\n<p>XMLHttpRequest支持使用abort方法实现请求的终止，axios底层封装了XMLHttpRequest来实现请求的处理，通过将调用abort方法的能力暴露给外部就实现了请求中断的控制。axios引入了cancelToken来实现这个过程的解耦。下面从具体的源码来看实现的过程</p>\n<h3>创建cancelToken对象</h3>\n<pre><code>// 调用source方法 生成CancelToken 导出token和取消请求的cancel方法\nCancelToken.source = function source() {\n    var cancel;\n    var token = new CancelToken(function executor(c) {\n        cancel = c;\n    });\n    return {\n        token: token,\n        cancel: cancel\n    };\n};\n\nfunction CancelToken(executor) {\n    if (typeof executor !== 'function') {\n        throw new TypeError('executor must be a function.');\n    }\n\n    var resolvePromise;\n    // 设置CancelToken的promise函数\n    this.promise = new Promise(function promiseExecutor(resolve) {\n        resolvePromise = resolve;\n    });\n\n    var token = this;\n    // cancel函数的执行逻辑 在调用cancel接口的时候 执行下面的逻辑\n    executor(function cancel(message) {\n        if (token.reason) {\n            // Cancellation has already been requested\n            return;\n        }\n\n        token.reason = new Cancel(message);\n        resolvePromise(token.reason);\n    });\n}\n</code></pre>\n<h3>cancelToken与XMLHttpRequest绑定</h3>\n<pre><code>    // 代码是axios封装XMLHttpRequest的部分逻辑\n    if (config.cancelToken) {\n        // 如果传入的配置有cancelToken 就调用cancelToken的promise方法 \n        // 通过promise实现控制流的流转 调用cancelToken方法的时候 将resolve时机暴露给cancelToken\n        // 调用cancelToken的cancel方法时,resolve了当前的promise，控制流程回到当前的后续流程，执行request.abort()从而完成请求的终止\n        config.cancelToken.promise.then(function onCanceled(cancel) {\n            if (!request) {\n                return;\n            }\n\n            request.abort();\n            reject(cancel);\n            // Clean up request\n            request = null;\n        });\n    }\n\n    if (!requestData) {\n        requestData = null;\n    }\n\n    // Send the request\n    request.send(requestData);\n</code></pre>\n<p>通过对实现流程的源码梳理，在类似的功能中可以利用promise来完成流程的控制。</p>","frontmatter":{"date":"2022-06-22","path":"/axios-cancel","title":"axios的cancel功能源码解读"}}},"pageContext":{"readingTime":"3 min read"}},"staticQueryHashes":[]}