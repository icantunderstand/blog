{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/react-hooks",
    "result": {"data":{"markdownRemark":{"html":"<p>React在函数组件中引入了Hooks机制使函数组件拥有了类组件的生命周期能力(本质上有差异),本文主要通过源码和图文的方式用最简化的方式来阐述React Hooks的实现原理.</p>\n<h2>前置知识</h2>\n<h3>Fiber</h3>\n<p>React为了实现时间切片,将页面的组件节点都进行了新的抽象-Fiber.通过引入Fiber结构React可以更好的实现组件更新的调度.Fiber结构主要有以下几种类型的结构:</p>\n<ol>\n<li>Fiber节点的连接结构,在组件更新时候需要依赖这些属性</li>\n<li>动态的运行数据(updateQueue,memoizedState)等,在渲染更新的时候会利用这些属性存储需要更新的操作和数据.Hooks的实现就是依赖这块的结构.</li>\n<li>Lanes 这里主要定义任务的优先级,Fiber Reconciler实现了一套新的优先级更新机制,这块在之后的文章会再介绍.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 538px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e25e72a540b8d4ed7997271e175c0bff/9516f/Fiber.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 141.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAAAsTAAALEwEAmpwYAAADcklEQVRIx5WV53LkNhCE9RjWMgeAJBgAxs1J2ZZ/uFx+/1f5XAtJt6dTSbf6MTVAgWxOs2caV2Hgk5oF+bRBH7fo+yOiqQiSGD8K8TzvW3EVhiHNYoveHOiPt4yrHUpr2ps1ejnhux6+718cV6cK9fpAu95TzVv648qCdfsVhSrsQ0EQXBxXeZFTtz1JViAzSakrVFORihTXcSzgtynHytjQqz0ilejlnigM8VwXz3O/R9n3PaKyQ5g57e6Wapgz3j8ji4IgSgniDM/1cB0Pd+bata3mtHdcu35jYQED3ycqe9Jmojs+0W6OZP0GNaxIVUE+GopekqgYNWWkKiZMAtIyITMpfuC/A30BzCSiKdD7jnJekY8leXeqMCCMfCIR2nWcRTafXg7jgDB9bSv3Jc4V5iXSaOrVRP9wS3dzQJYS0Q4IlRGEPlEa2ghf8499EtgPhkn4S4VaoaaGam3ITYY0FbLJyHuBqBOyVlAM0mZpUpvtWZWQd8L+gjNgPZI2c8z2jma+RRQ1absmjhOcmXMWxXFf8znezt5TVoa0GWyD18sdZdsT1z1pUeF7l0/Ka4UeUTWS1CP98U+qcY3uB+JE4PsBfhB8fPFrwJMoyopSTi1CpYjeIGuJ5zk419c4s+vXPMPz/Hd996GxX0TJkaam2Yw0mwV6t6TZ9IhckpuBoptQ/Zys1l+CnQGrAWFWTI//0N08Mz39S3d4otQtanlDOa6RtUaoitNk/R5QtQgzMdz9RXt4YLj/m3paISpjxzKKIpzrP3CdSymr1qrc3zxhDg+0h0erdlFrEr1AqvonAO8yyrJfs3j+j253R3/7TLe7JYwioqKx2buwfV5FEaRVhhobEhmRqpxY5i/2NbvGc50PrvI1YGlI6xazO1DPF2TDkmR+RAwbokwRJJIgCC+q8mxf9US7e8ScYn9v7xnZLSxw0q+JUmErvpByTj5ozHFOvR3J6oYoCAhlyenO8ay63xGlqBFaY/YbqrElLg1Bv7XzHLhnZ35z69+3TdEgdEe9XNOstuj9kaLtEIst2e6GrG0J4xdT/dmhP7lTTrOck48NejdQrwaazclYBdloKFc1WSuRTWq9781IPwVM4tgqGUqFrAyZ7slOExIlRFlNGEYvlN3zVfkl5dNYBZ5nx8qdzayzuNZV3F/EeG9Tn1X4P50bH358JSUOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fiber结构\"\n        title=\"Fiber结构\"\n        src=\"/blog/static/e25e72a540b8d4ed7997271e175c0bff/9516f/Fiber.png\"\n        srcset=\"/blog/static/e25e72a540b8d4ed7997271e175c0bff/63868/Fiber.png 250w,\n/blog/static/e25e72a540b8d4ed7997271e175c0bff/0b533/Fiber.png 500w,\n/blog/static/e25e72a540b8d4ed7997271e175c0bff/9516f/Fiber.png 538w\"\n        sizes=\"(max-width: 538px) 100vw, 538px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>update</h3>\n<p>react在处理更新中引入了update的概念,在触发更新的时候React将update插入到对应的updateQueue中然后调度页面的渲染更新.最后通过updateQueue的执行来完成更新.</p>\n<h3>React Fiber Reconciler</h3>\n<p>React为了实现更新可中断等特性,在具体的渲染过程中会维护两个数据结构:</p>\n<ol>\n<li>current Fiber树结构  当前展示的页面结构</li>\n<li>workInprogress树结构 在更新中添加了更新但是没有渲染到页面的结构</li>\n</ol>\n<p>在具体的渲染过程中主要分为:</p>\n<ol>\n<li>render阶段 render阶段主要根据已有的Fiber节点构造对应的workInProgress节点 这个阶段实现了任务的中断,优先级任务处理等逻辑</li>\n<li>commit阶段 commit阶段主要根据Fiber节点的类型不同来执行对应的更新操作(更新Dom等)</li>\n</ol>\n<h3>Hook的数据结构</h3>\n<p><a href=\"https://github.com/facebook/react/blob/0203b6567c6fd6274866c853ef938241d24551ec/packages/react-reconciler/src/ReactFiberHooks.new.js#L140\">hook的数据结构</a>如下:<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 477px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.599999999999994%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABuklEQVQoz12S6W7bMBCE/RiJJR6iSFESJR8SLV9xbMcJkrRpgbz/w3yF7RxIf8zOLkgOONgZ5eUYYTIeult+bxLKpcfWhiRJkVJeIIRACkEq5AXn+RNf5x93R9ooYuh5iWu6psQuD/jVQHW/IrQNw7C4PlASowUuS1FaIrX8IfbJI+UbrHX0z+802xPd6Y3++Mx6s6ONKyZxQGcp+dSy3yreNzc0y4KwLcnLjDT5/t1F8FxsUdA9vNIdn+kfXqjbCZP7I9Z7tDFordEmJ880uRZIkyGVQsqfYlfBzGBdQXz6Q3d8Zbp/pF0tyQ4b7GHD/PBIPdxTL+7o1nvKukYPPXmoEUlKeoG48jhlpJs51uY06y3ToaeMNcVhgdt0mDihPw28nSJxEeif9sxjwC5nuNhiS4MLOcZn2JBTTCwj3fZoLSm7OXUMlHczfF9RTT35NNBGx6/1Dbujwy8L2sHx96SIiwwTLH7mcK3FT92lH8ncEReRyWpH5StUE1DekzmHDhVKZaSZxlQGdWYtOM7G1CZhfPth9cPuxbIUKbM2oERKkowRSYJI0yvO/WcGk+/s3Y6vefx/Ieel/AOaqgbxYD1/+wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"hook的数据结构\"\n        title=\"hook的数据结构\"\n        src=\"/blog/static/c3abb96049ba35de696bfaeac50d17b8/d743b/hook.png\"\n        srcset=\"/blog/static/c3abb96049ba35de696bfaeac50d17b8/63868/hook.png 250w,\n/blog/static/c3abb96049ba35de696bfaeac50d17b8/d743b/hook.png 477w\"\n        sizes=\"(max-width: 477px) 100vw, 477px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2>Hooks实现思路</h2>\n<p>Hooks在组件初次挂载和组件更新阶段是调用的不同的<a href=\"https://github.com/facebook/react/blob/1d1e49cfa453b58769e87c3c8d321024d58c948f/packages/react-reconciler/src/ReactFiberHooks.new.js#L389\">实现逻辑</a>\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 561px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABh0lEQVQoz12RW5LaMBRE2caAJOthy5Yf2NgYg4cZBuaZqmwgO8j+N3BSCFKZykdX36+jVvfCWEsTajZhTZo6pFghpUBIiVQSldx1vZVCJYpEJ7dbqpvHWyKlZGGMwWWeamgJU41tCsquoN/ldHNFMZaUu5uyxpLVhnxj0VYhhIiPR93BC6MTdFHh9i/43RNuODBNAz+eB86PW4qup5lm2scToe1wRcA3bXRjNNqmJDb7ntCSKIXPc+rjK/XzB1+niffTgf00kh8/KS8/8eue0O8Im5FymMjbgTIE0qImSYsIjAmtMUSoEJhmi9u/8evS8fur4+04IsZX7PyJrTrEwwNitUKsljcJgbh2Hr9+T+icI8sc2imM19jgSIPD5A6dWbS30dMyxVqNWC4j4JomSZJ/o/zt0DqHrRvqQ8/mcqQ7jfTHNU8fW+bzht15y+ZlZj13tIcD5bCn6rdcx/wfdhvFWJRJMc7j8gptPUZrqpBT5BlZ5mNPxmZYH0jLGl/WESjvvX0H/gH+iejWe9cPNwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"挂载不同的hook\"\n        title=\"挂载不同的hook\"\n        src=\"/blog/static/79d42a604971a40c38b3cd9a50682d77/410f3/different_hook.png\"\n        srcset=\"/blog/static/79d42a604971a40c38b3cd9a50682d77/63868/different_hook.png 250w,\n/blog/static/79d42a604971a40c38b3cd9a50682d77/0b533/different_hook.png 500w,\n/blog/static/79d42a604971a40c38b3cd9a50682d77/410f3/different_hook.png 561w\"\n        sizes=\"(max-width: 561px) 100vw, 561px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 501px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 86%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC2UlEQVQ4y3WTyXLrNhRE/RGpLCxxEmdwAMRZokRNfJKVOMvsUtnm/7/gpEDZtPwqWTQuCkU0+t5uvqyCJY5I8JTArRR+uybqC8S+JOr0vkEcWqI6I94mxENOuM2IuoSsFsTrEFessGwLwzB4MU0LX1bkdYs6nEl3J8J6x1KUGKLAlB1G1mIGKXEmyNsS2RTEWUIcx/i+z+J1gWmaE15WhoEQPuOl5XQoGc81SgmS2EVmAZnwWMuQRAQYyyWmxmIx1eVyOanSRIZpPBQahkmaxozjht2+4nRuSfKM263n9tZzPnfs9jVxHKK/NcwPGMYX2VOdCJMk4nLpOB5rqloiVcr53HI41Ox2JUKEvL4usKxHW7rato1tW98Ip5YfCiOOp2ZSud9XDEM1Ky5rxfHYTI9dxm56YLNZT4/1fUEQeCyXT4R60Qq1ov1Qsd0WDENJuykoypy2lVRVNhG1raLrFEJELBaP+VmW9V3hJ+H9tx1v9z1Vo6aZ3W5b3t8HpBSzCt22JnpW9PMcZ8K3t57h0EztFLXi8qMnzRNUkZLnMauVM8/vk+y/8GXK2LHtS1Qp+eua8c/vGX+fQvrU4pdfX1ksFt9j8uHyz5gVjmPH9brlcGx4P0rufcKfo+SPsWY/NJNRdZ3jee5E/L8K9aJzqHOnM6gvnsYt3b5h3ZQcz93kuI6VToB2t+vWSJl9jMCaq8Yc7NOpmXOnL9banF3FYajm82GoyTKB6zpTBrVJzw4/5TDmft9xvfb8uG4n6MvNpmTbPzJ5vfVcnqpSKbEIcBznQfo5Qy3T911UHrJWMUrG5GmAiFakwp/UpImPkhHFhHBC+vGvu471NdNPU9wgws9LoqLFFTlxtSHpBgJZEsoCP1UYXoSZ1Zhqg7nusfIGI5bYaYnjehjGg/TFc13WdYUnMoJM4kUxYaaIZEGQ5ngixYsEdhBhixwnkTjpetrbUYoVCmxnNQf7XxK2AFDTeZdbAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mount阶段hook\"\n        title=\"mount阶段hook\"\n        src=\"/blog/static/55b46db6b69afb0beaa46bd58608e2fb/55811/mountHookCode.png\"\n        srcset=\"/blog/static/55b46db6b69afb0beaa46bd58608e2fb/63868/mountHookCode.png 250w,\n/blog/static/55b46db6b69afb0beaa46bd58608e2fb/0b533/mountHookCode.png 500w,\n/blog/static/55b46db6b69afb0beaa46bd58608e2fb/55811/mountHookCode.png 501w\"\n        sizes=\"(max-width: 501px) 100vw, 501px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 485px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.60000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC5ElEQVQ4y31UWXLiShD0NWwQvbc2hCS0byBWY3vuf52c6MIm7Bi/91FUtEKR5KZ+YpxD5x3kOodq9jDDBbIcIZsZshgh6xlquEJ2J+h1inVXYj02SMYaQZYgCkMIIeB5HlarFZ7cj7YW075GO1ZopwbpNoMnFDwu7iM0llxhxTiMVjDW0JZSgDNGQA9Axhg4W8EaBaMlrJFQSkBwBqU4pORQgkFrAc4Zlsvlt/EI6AvM7SfPWyEIDI7HBtNU0s6LFHWT4fY2Yrer6Lnb6ySEe5+xFQF8nwfDB+CpJbBhLBFEIU6nhp6dzy2GYYvFwsPz8wsWizs7t5+fF3h5WfzO8HRqsd9XaJoMZZXi42PC5dyiKDeo6hTbbYJkEyJNI3p/swlRVRtkWQQh+HeGHqLI4nBsCPT8Cbzf18i3G+znGpdrj7e3kSz4+LPD4VCjqlJkeYwsi6GU/CnZ9w0ulw7nS49su8E8V5jnGvOhQd9vKU1jFKyvoV1wVoNz/mnBL5J9X+N67Qm06wukeULeubPzsW0zJEn06Z9HHn6B/Gcor689hrEi/3b7is7TVBErYySx/D+gryHAMLQ4nzvMhxplnWEcS/LUyXZ1ieOAOujkOqmOqZvvUn8ABqF5SHbAh0ODqsnRDwUFcn3tcbsNFMYwFIgiH9YquI/iV4bOQ5fwtCvRtBklO4wF8uKesuunA+u6nABdUGW5gZTyH5YPyU6u+yKczHEqsS1SYkh/NJXEepoKssCl7KriAvql2B4Bvr1PuL4OOF866ptj5WR3g/Ozxe024vU23Dv5PlHFXOlTV2z547ZhdAFEgUISG8SRQRgoGMXg2/uF4FuJdWyxjjQ2a4M4kAitQGAF4lBDsBWWD0DPgzA+4mZCMhxhkhzrbo/t8Z12VHWIqgEyiLHKevBqhuiu4PURPB/AshYiKegaI8lSCKRpBi4VpLH3sT6N0AZCaRouBJjSYNqCGf++3VlqMKEeHv4Fc1cdpF0sQpIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"update阶段hook\"\n        title=\"update阶段hook\"\n        src=\"/blog/static/25312134b5bc77843da2562709c24e6e/44c61/updateHookCode.png\"\n        srcset=\"/blog/static/25312134b5bc77843da2562709c24e6e/63868/updateHookCode.png 250w,\n/blog/static/25312134b5bc77843da2562709c24e6e/44c61/updateHookCode.png 485w\"\n        sizes=\"(max-width: 485px) 100vw, 485px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\r\n下面先整体的介绍不同阶段Hooks的实现过程然后在深入到源码中看具体的实现.</p>\n<h3>图解hooks的实现思路</h3>\n<p>Mount阶段Hooks的实现逻辑\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 652px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/38746c08a5fcd5ae402c6fdb39b40b99/a6d32/MountHook.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAZABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe41ACywA//EABgQAQEBAQEAAAAAAAAAAAAAAAABEBEx/9oACAEBAAEFAuuplTxU2P/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CT//EABgQAAMBAQAAAAAAAAAAAAAAAAABMRAh/9oACAEBAAE/IahEZ0sjaDhY4Qf/2gAMAwEAAgADAAAAEPMPDP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EAB0QAQEAAgIDAQAAAAAAAAAAAAERABAhMWFxgaH/2gAIAQEAAT8Qrh+MUpA9kxcjfuquM850VugMJcJEJNd2j//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Mount阶段hook逻辑\"\n        title=\"Mount阶段hook逻辑\"\n        src=\"/blog/static/38746c08a5fcd5ae402c6fdb39b40b99/a6d32/MountHook.jpg\"\n        srcset=\"/blog/static/38746c08a5fcd5ae402c6fdb39b40b99/0479a/MountHook.jpg 250w,\n/blog/static/38746c08a5fcd5ae402c6fdb39b40b99/41099/MountHook.jpg 500w,\n/blog/static/38746c08a5fcd5ae402c6fdb39b40b99/a6d32/MountHook.jpg 652w\"\n        sizes=\"(max-width: 652px) 100vw, 652px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span><br>\nUpdate阶段Hooks的实现逻辑<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 685px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/acf124ecaccb1c0fb4fe2140077cba9c/0a2b8/updateHook.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 149.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAeABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe41koLnUIo//8QAGhAAAgIDAAAAAAAAAAAAAAAAARAAAhEhMf/aAAgBAQABBQLMJ0jwK0CK/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAFBABAAAAAAAAAAAAAAAAAAAAMP/aAAgBAQAGPwJP/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAEQETEh/9oACAEBAAE/IdYaKYuqbENSG5CWhYf/2gAMAwEAAgADAAAAELPKMP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EABsQAQACAgMAAAAAAAAAAAAAAAEAERAxIVGB/9oACAEBAAE/ELWLcdRBAK7jpXG6a8By34Qa79MFQlwgKCp//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Mount阶段hook逻辑\"\n        title=\"Mount阶段hook逻辑\"\n        src=\"/blog/static/acf124ecaccb1c0fb4fe2140077cba9c/0a2b8/updateHook.jpg\"\n        srcset=\"/blog/static/acf124ecaccb1c0fb4fe2140077cba9c/0479a/updateHook.jpg 250w,\n/blog/static/acf124ecaccb1c0fb4fe2140077cba9c/41099/updateHook.jpg 500w,\n/blog/static/acf124ecaccb1c0fb4fe2140077cba9c/0a2b8/updateHook.jpg 685w\"\n        sizes=\"(max-width: 685px) 100vw, 685px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>源码解析hooks的实现思路</h3>\n<p>以下主要以useState这个hook来分析React在mount阶段和update阶段的源码实现.</p>\n<h4>mount阶段源码分析</h4>\n<p>在mount阶段组件,useState调用的<a href=\"https://github.com/facebook/react/blob/1d1e49cfa453b58769e87c3c8d321024d58c948f/packages/react-reconciler/src/ReactFiberHooks.new.js#L1235\">mountState</a><br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 548px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 107.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAADoUlEQVQ4y22U23LcNhBE9Rn28gKCAAEQvC+X3OVyL9JasqWU/QGpylP+/x9OilQiy4ofmoPCQ3Ma0z13URSjfYXvR4ax4++vnr/uDX9eLO22RbmcREqiJGGz2bAJAqIwIo5joui1vsfd8im85XjsGc8Du9tMO+8ZzzO7457Dw4npeqQ+9NR9y9B3GGcJw/CN5D3xXRxHZK6g2J2wuyP29MgwdDx9O/Ht+cSXxyP3t4mH28TXx5k/ns7s+o4kka+dRr+Srh1abTGZI+lGRNlRtpZhX7HbV/RDSV56jNF0PqOvLE3lyMucRAli8aFDIQRJkpAXGbtDyTjX7C8trrTU25x+qhjPDbt9jW880iakTiJNQlYqhBTvCCPulj9YYzBZiss1zmlyp5FSYIxaz84qnNUomRJuAsIwIghCgk241vDdkO7SLEAZi6o9xbHGTzX+UOH3NaZe7h2685gmR2aGVGdImaB1is7S9adpKn++oVQhqc3R+wPtdaa7n2mvZ+rzTNlX6G2HPRyo55linHHtDpNptttyxTDUVJUniv6VLHVIqg2qKtFdgR53uMbihhY7DTSnkWJs8JUhCgPCxYdRRBi8yg2C4M1Cq+TlIJUmH69Ulxfc8RGZd6hyR6wcOq+R2pEIuXaxvNeC6IOh3yQvU5aJoBz27J9e2M5nTNPjtwNKxog4RIoQlcZoJdbhZUoixP+Tsna4EAqR0Pcl379feHk58fw88+PHdTVzs+s5fbnn9PjA9fmJ6+OZ6ctEWRWr7N9Gz1lHVXgKb/Aue0Vu1kmKVCOtR7kC5SukNljvsCb7fZaXS5MXlMcLcdEQdRNhM5J4j596yn2PsRmfP31i8/kzwWZDsAnYbII3wg9JiSmMoZkG6vsz1e1G+3hj+3Bhfroxjj15btboWZuRZQqdqfW8JOxjl3cijtn6nCIvsbszqujwZUPVHzCuwKRyfd/FbwsW77VtwTg2KJX+snXeZVmgq45yP5NvB8rDmXy3X1HN92hfs/m87ML/vBf+IvnDUARKStJuws7fUMvWSTNEote6IkmJwvgdohVh8BPr3WqbNMIZg64r6suJujUIGZDaiNS8QmYxyiZoJ1BWkC4bx6aoPEW51yp18m+WdUiWGbqhpj3U+OtEPo30Tye625H+64XmPJDvW/z9EX+Z8GOD9ilZqckKta6xNJOvhIlM8XVNbh2ZNsSmRLoKU3Zr7Fa4EpFaYtcgbIVIs9XUHyUvhP8Axs1mSXuqYs4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mountState代码逻辑\"\n        title=\"mountState代码逻辑\"\n        src=\"/blog/static/52a5be7aa726b705f79a180697dd6fe8/a58fe/mountState.png\"\n        srcset=\"/blog/static/52a5be7aa726b705f79a180697dd6fe8/63868/mountState.png 250w,\n/blog/static/52a5be7aa726b705f79a180697dd6fe8/0b533/mountState.png 500w,\n/blog/static/52a5be7aa726b705f79a180697dd6fe8/a58fe/mountState.png 548w\"\n        sizes=\"(max-width: 548px) 100vw, 548px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><br>\nmountState主要做了:</p>\n<ol>\n<li>根据initialState初始化memoizedState和更新queue</li>\n<li>返回memoizedState和更新函数(绑定了当前的hook的queue)</li>\n</ol>\n<h4>update阶段源码分析</h4>\n<p>在使用useState返回的回调触发页面更新的时候是调用的<a href=\"https://github.com/facebook/react/blob/1d1e49cfa453b58769e87c3c8d321024d58c948f/packages/react-reconciler/src/ReactFiberHooks.new.js#L1901\">dispatchAction函数</a><br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 485px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 142.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEE0lEQVRIx5WVZ3LbSBSEdYy1CEwexAEIEgRzkinJYe3avf9lvq0BJZVkOdT+6HoDFNmYfqlvpFRUw5bp6RNlG9g+bljtZlReEgpNmSmcc1hrEFKSpilCiF/iRkpBvdyxuHylmnVMH09M7/aUhw3tbk0z7+jmHVopkiey35HeaGNol5uRtOrmhKbCCYGTEicFXimsUggh3/35Z8Q33vuRJLn9QDK5JZ3cjjFJJuON0uSWNJkgXiFNkheyH0lvjNYI41FZjfQFqu6Q9YzUVwhtmfjAxAUS3zBxNYmvsb7A6J+nYCQ07QrbH9DdCrd7IOsGloct203P+v6B/efPLD9eWF8+0py/Mnz6l+l0SpIk7yVHQh0W6DAgQ487fcOHKdPdnOnDgeG4ZLGe0fUNy74lyzNsXmKt+4VkY5DGEbZ3FLMB4Quk9bjMUdQlZZFTZh5nLbHF4q2uOU5II0nM8xvJxqCUojtcmJ/ux557TnoySZhMkivJq0K8IJK9kxwJjWH+8Qv9/Tf6+79ptydc3aLCApNXSJH+sV3eSpaKxeN3uuOF+d2nkdCEOeVii9b6j9ORvpJ9Y43B+2xsbFfUlM2UvJ2T1w3T1Y5YtGe5L0je4t0Nq1ChjEA5ibQSqQVCpSgnUCY+K5RVKBOjRHuFzq7niNcfu7Gxeial6B3Tc0U5s+StIWwL6nVG3hnymaFeO8ImJwzV+BFbGIzXmEz/eENN2Q90hz3FekF+OONWe8quor/c0R0PY1x8ume4nMhy/06mlPIFo+R2GqiHLWbziFpeKIc9TWixsz1VN1CFKUI6jCve5e8FT7kdCbUWmMLh5wHblGShoOwyTJ3hmwxfGbLOYnI1SsymDltoTK5xlcEHO76P5yuhsfjtBbc8UPUL6mGFyzx2dcStDriiQMgJUgmEFMhYKCWeEIsmr++VuBYlL0rq3YUQW8dnaOuvOfEFwmbjaBqXoZR+2z4/wXhDoTTu+BWz/0y9PTM73lNUNW73iD1/p9jc0QwbsiqMY/lbC4heYZ1HtsMI0/bk7QxflOgyoPs9tmrGxft6Yn41PaPkajojqwNZWVG0HXloRw8RcdkWARn95DZu8skY0zT5tQXEWW02JxYP3ylXZ8rjF+q772SzFdXmTPvwD/ViTdH1VIs19bAZFf0o/WWWYw5dmVMNgXBqyBaBfNUgYxFEis0LrM9xRTUuVl+FsStGgvT9FnpasCl572iPJWGXU608QsSFIJhMJuMPJ9HEonF9+GuMo3FFJ0yTt9smEvaLltN5yWY74+NlzfluyXY353DoWa9nNKs9Tdw8RY1dnrBVi14c0fMdbnmirMOV9NlGn41cKYnWakQ8P0NIhdRPS0Dp8fka5Rhjzz5bwU1c+dEC3u28/4unKv8HIjYjhkrSpr8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dispatchAction代码逻辑\"\n        title=\"dispatchAction代码逻辑\"\n        src=\"/blog/static/ffb63f0539dcde4bca5e0f77c2ba284d/44c61/dispatchAction.png\"\n        srcset=\"/blog/static/ffb63f0539dcde4bca5e0f77c2ba284d/63868/dispatchAction.png 250w,\n/blog/static/ffb63f0539dcde4bca5e0f77c2ba284d/44c61/dispatchAction.png 485w\"\n        sizes=\"(max-width: 485px) 100vw, 485px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><br>\n在组件更新执行到对应的函数组件的时候,会执行对应hook的update阶段对应的hook逻辑.useState对应的就是<a href=\"https://github.com/facebook/react/blob/1d1e49cfa453b58769e87c3c8d321024d58c948f/packages/react-reconciler/src/ReactFiberHooks.new.js#L1262\">updateState</a>.从updateState的代码可以看出useState底层是使用的useReducer代码逻辑.这样具体的更新逻辑就在<a href=\"https://github.com/facebook/react/blob/1d1e49cfa453b58769e87c3c8d321024d58c948f/packages/react-reconciler/src/ReactFiberHooks.new.js#L710\">updateReducer</a>中了!!!\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 570px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 152.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEZElEQVRIx42V627cOBaE/Rg77pZ4E0mJut/VdrfdcWIn2SAXLPbH/pknmEeYh/8Wkp0gcOJMfhRIUFDplFh1zoUwlmqcqMeBfqg4HGemZaAZW/KmpMg8oQhIKYmiiDiOf4kLEccMVwvL+ZZmPjKMM3mWYROL0opov3/EE9nz9QdCpTXF4YZyWnBdRzZNuDxDbRW9XMmLhFpryjylrXPqsaYeaoauJnjLfndJtN89w/6XVV7EQiB9ifAFohxQNkWEFlEvqGpGVROyGJDFiKhm0rJBq5f/54WQEt0e0PWMO38gGxbcckc4f6R7+ELaLcTKYHyK8gGlDHEcEb14KVJhljck/YlweEV195Hi+pb6/i3N4YZ6OdFOM68/vGNcRnRI0do8XVb0Ay6EEOgsJSlTTBkwRSDrM4oxJ60dWVuQ9TVp35K2OdVUEKoUmQi0V5hMo53CpApp5COh8THp4nCTJWkMaZ9QXDnCYjG1JvYxcRpjgiIWEULFCCWQWiAT+bgasZ1thDIEjq9K3ryquLkOmMQgbEpsM9oy5TwUnPocazT7VVr0hOeSo4iLNQEubfjz3YG//3fDX58WuqZENTOiueJmbnk7ZdxPAZ9o9v+QlgspBEliqPucfspphkAoHdOcMTSOsrbEmWGnInaXu1+a+lv0pMuQ5YSuBlR/TVEEPt8f+O/7Ew9317SvHqimBW2Sf8zzhRAx0q43PDA9fGR695lqOWLrAVnP2PZAVjW4qsNmYbPLbxHqsqd//Z7p/Rf6Nx/ozvcU4wFfNqi8Q2nDfve7km2GKSeGh88M95+ojm8oz/8mdDM6SdF5j1L6N9uXEAitN1O3d1dUxxbfOuxQkXYeWyqSIDcjPyd8oTnEpImnLgu0F+hUbglQ+sm8Rm7YCJ78tt9FL3acx+gpjbYaN1jCwZONDlsmKKtQaxKM2OK17pWVmKAR8oUKpZCspD51jF1D1RfodJWpcVXymFWvsKXZzmxh8K3dqv8p4RY9KTFa05aBckxxjd6w/oJ1TXJFUhpck3B5uefyX7tN+lfJ3xN/I9xInSZfKrKhJIwVWV9RnTp8k2GMwjpFliXbfn1v/5Pu/UioFEpIQqgY336iubmnmg6Md++Y3v+H8nBDezgxHE8cz1f080xVNyTeIZ5dzEaopEJIQVP1LPOJUJWI3SWJdRifoa0jyUuUS1HGkaQ5qfdYZ39O+FXy+kWZOIR2REmKEAptPSrxSGW2/frSmphV7lfJ32NrX+soXcem9hm2rfFLh5tnXJlRna5pzgfysaM8zGhjiJ/yvBbzo21WQqW2CrOqpj3fUh8Xiibl6twyzgXt7UJzviUfWlQo0c2MDzlRtH8hekJiE4Pzjkgookiw++MSGUeo9bnUSJ1ssoXSxNtePcr8zjqb5HWMrqRZ0+GrlnXwu6LClQ1JKND2ceBv+Dro97ufWuZbhYkx9P0143RDNS709x9plmvKYcHWE0VeELqJrJ/xaYrLAr7ucd7/IPv/GmRg+gK7bPkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dispatchAction代码逻辑\"\n        title=\"dispatchAction代码逻辑\"\n        src=\"/blog/static/275788fe27b5e1522a0d62b15f3b7910/432e7/updateReducer.png\"\n        srcset=\"/blog/static/275788fe27b5e1522a0d62b15f3b7910/63868/updateReducer.png 250w,\n/blog/static/275788fe27b5e1522a0d62b15f3b7910/0b533/updateReducer.png 500w,\n/blog/static/275788fe27b5e1522a0d62b15f3b7910/432e7/updateReducer.png 570w\"\n        sizes=\"(max-width: 570px) 100vw, 570px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><br>\nupdateReducer主要逻辑如下:</p>\n<ol>\n<li>根据fiber上存储的hook链表获取到当前的hook,hook的更新queue</li>\n<li>循环执行hook的更新queue,将执行结果保存到hook的数据结构上</li>\n<li>返回处理结果和更新函数</li>\n</ol>\n<p>以上梳理完了React Hook的源码执行流程,也能解决开发中的一些疑问:</p>\n<ol>\n<li>比如hook的添加为什么不能使用条件语句  因为前后会导致hook的链表无法对应</li>\n</ol>\n<h2>参考</h2>\n<p><a href=\"https://react.iamkasong.com/hooks/prepare.html#%E4%BB%8Elogo%E8%81%8A%E8%B5%B7\">React技术揭秘</a></p>","frontmatter":{"date":"2021-03-17","path":"/react-hooks","title":"React Hooks源码解读"}}},"pageContext":{"readingTime":"5 min read"}},
    "staticQueryHashes": []}