{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/eslit-plugin",
    "result": {"data":{"markdownRemark":{"html":"<p>在<a href=\"https://icantunderstand.github.io/blog/2024-4-1\">板凳快报4月</a>中聊到了react组件中hooks的使用泛滥问题，当hooks使用过多会有如下的问题:</p>\n<ul>\n<li>代码阅读性差，逻辑分散</li>\n<li>性能差 过多的hooks更新会导致页面多次渲染，</li>\n<li>hooks之间的依赖耦合增加  本身hooks的依赖就已经很难治理，hooks之间的依赖更加不可控。</li>\n</ul>\n<p>在思考这个怎么解决这个问题的时候，希望可以通过规则限制的解法来解，因为只有可定义的规则才能在长期的代码维护中一直比较好的运行，在规则与人工review的结合下就能比较好的实现代码的长期治理。本文内容主要基于此，介绍eslint插件的开发过程和react hooks数量限制插件的使用</p>\n<h2>开发eslint插件</h2>\n<h3>生成插件项目</h3>\n<p>eslint提供了生成插件的工具<a href=\"https://github.com/eslint/generator-eslint\">generator-eslint</a></p>\n<pre><code>// 安装全局依赖\nnpm i -g yo\nnpm i -g generator-eslint\n\n// 进入到插件目录，生成插件模版\ncd testPlugin\nyo eslint:plugin\n</code></pre>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 459px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/d5cc76478b75cae9f4320f91e10e6e38/48711/createFolder.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABSElEQVQY032P23KCMBCGA7XTKYpWBKylHEQ8QMIpCRCCHNSLvv8bdYLctjPf7uz+O7uzP1gkxTqvNgVfY7bBzGKtgggIkBRAcIikAEoBlI9QPkHpCOWxfSovJwjUtDr1j01empRbVevw3msGHTMtK2fHBOwj4I244VT4ULAfeUfUb+8faWEWza5sLNa5Tf/Nul11NWm9jOkyoQtETMqVMJ9DPAticfF5Yp4UQXvfktpirUm53921vLJ57zbDWHR23bnNsG9vBmZ+e/tIy9eISgESy28R/mStmldm0Ti8Dx8/OmZ23emYrdJSyyoVUYPwZUx1XBukNjCbIyqfc7EsfrhkABIFErvuHN5vaa3lFfAuwuF+xAun7IWT6I+fAx9KkICYqlnpXQdHGL6u01LoB/QXk2cR5xRcMgWRr7IxCFslhXyA0/hffgFEoEIJj3nRfgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"创建文件\"\n        title=\"创建文件\"\n        src=\"/blog/static/d5cc76478b75cae9f4320f91e10e6e38/48711/createFolder.png\"\n        srcset=\"/blog/static/d5cc76478b75cae9f4320f91e10e6e38/63868/createFolder.png 250w,\n/blog/static/d5cc76478b75cae9f4320f91e10e6e38/48711/createFolder.png 459w\"\n        sizes=\"(max-width: 459px) 100vw, 459px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>开发调试</h3>\n<p>在创建的文件夹中，在rules中增加自定义的规则。在这里我们要限制hooks的数据，添加了no-too-many-hooks.js,内容如下:</p>\n<pre><code>\"use strict\";\nmodule.exports = {\n    meta: {\n        docs: {\n            // 规则描述\n            description: \"no too many hooks\",\n            category: \"\",\n            recommended: false\n        },\n        fixable: null,  // or \"code\" or \"whitespace\"\n        // 规则的参数配置 这里设置了两个参数 list代表要关注的hooks列表，numLimit代表限制的数目\n        schema: [\n            {\n                type: \"object\",\n                properties: {\n                list: {\n                    type: \"array\",\n                },\n                numLimit: {\n                    type: \"number\"\n                }\n                },\n                additionalProperties: false,\n            },\n        ],\n        // 报错信息描述\n        messages: {\n            hooksLimit: \"too many hooks you called\",\n        },\n    },\n\n    create: function(context) {\n        // 累积的hooks数目\n        let currentNum = 0\n        return {\n            // 解析ast的节点 可以通过[astexplorer](https://astexplorer.net/)来查看对应的节点\n            'CallExpression Identifier': (node) => {\n                // 获取当前的配置\n                const options = context.options[0] || {}\n                const list = options.list || ['useState']\n                const numLimit = options.numLimit || 5\n                // 命中 当前是hook调用\n                if (list.includes(node.name)) {\n                    // 累积数自增\n                    currentNum++\n                    // 当前的累积数大于等于配置的数据 报错 匹配到too many hooks you called\n                    if(currentNum >= numLimit) {\n                        context.report({\n                            node,\n                            messageId: 'hooksLimit'\n                        });\n                    }\n                    \n                }\n            },\n        };\n    }\n};\n</code></pre>\n<p>在入口文件中导出规则</p>\n<pre><code>\"use strict\";\nmodule.exports = {\n    rules: {\n        // 规则名字\n        'no-too-many-hooks': require('./rules/no-too-many-hooks'),\n    },\n    configs: {\n        // 定义推荐用法 在使用的时候可以通过recommended或者自己添加当前rule的规则来设定\n        recommended: {\n            rules: {\n                'hooks-limit/no-too-many-hooks': [1, { list: [\"useEffect\", \"useState\", \"useCallback\"], numLimit: 5 }], // 可以省略 eslint-plugin 前缀\n            },\n        },\n    },\n};\n</code></pre>\n<p>在开发过程中，需要不断调试当前代码是否生效，可以通过npm link的方式，在插件的目录执行</p>\n<pre><code>npm link  \n</code></pre>\n<p>在需要使用插件的目录执行</p>\n<pre><code>npm link eslint-plugin-hooks-limit(定义的插件名字)\n</code></pre>\n<h2><a href=\"https://www.npmjs.com/package/eslint-plugin-hooks-limit\">eslint-plugin-hooks-limit</a></h2>\n<h3>安装插件</h3>\n<pre><code>// 安装eslit\nnpm i eslint --save-dev\n// 安装插件\nnpm install eslint-plugin-hooks-limit --save-dev\n\n// 在项目的eslint配置中加入配置 这里设置2个hooks的调用触发eslint的waring\n{\n    \"extends\": [\n        \"next/core-web-vitals\",\n        \"plugin:eslint-plugin-hooks-limit/recommended\"\n    ],\n    \"plugins\": [\n        \"hooks-limit\"\n    ],\n    \"rules\": {\n        \"hooks-limit/no-too-many-hooks\": [2, { \"list\": [\"useEffect\", \"useState\"], \"numLimit\": 2 } ] // 可以省略 eslint-plugin 前缀\n    }\n} \n</code></pre>\n<p>假设react组件中有这样一段代码:</p>\n<pre><code> useEffect(() => {\n    console.time();\n}, [])\nuseEffect(() => {\n    console.time();\n}, [])\n</code></pre>\n<p>这个时候运行项目的lint脚本\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/bc351a5e58200d9eaf8c5fa11931db9d/25260/linInfo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAhUlEQVQY03XPSw6DMAxF0ayCOLIdf4GkA/a/vAoqmKCegXU9fEVE5pzuToi1VgB4338KdbZYUawhthsAtAZP1z8KCqZ7bHtue2bGxd0iwtwzQ1XphZmJqJBYrusc4zPnGOM4Dndn5i7SL9JFVc1M5aSq7mZmIloaQHtG3DvflmW54+zf+wV4oiC+TrPnpgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lint报错信息\"\n        title=\"lint报错信息\"\n        src=\"/blog/static/bc351a5e58200d9eaf8c5fa11931db9d/00d43/linInfo.png\"\n        srcset=\"/blog/static/bc351a5e58200d9eaf8c5fa11931db9d/63868/linInfo.png 250w,\n/blog/static/bc351a5e58200d9eaf8c5fa11931db9d/0b533/linInfo.png 500w,\n/blog/static/bc351a5e58200d9eaf8c5fa11931db9d/00d43/linInfo.png 1000w,\n/blog/static/bc351a5e58200d9eaf8c5fa11931db9d/25260/linInfo.png 1113w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<hr>\n<h2>ps: lint插件写的比较简单，大家可以自己根据代码自己修改使用</h2>","frontmatter":{"date":"2024-04-18","path":"/eslit-plugin","title":"react hooks过多，你需要这个eslint插件"}}},"pageContext":{"readingTime":"5 min read"}},
    "staticQueryHashes": []}