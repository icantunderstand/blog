{"componentChunkName":"component---src-templates-post-js","path":"/react-scheduler","result":{"data":{"markdownRemark":{"html":"<p>javascript的执行是单线程的,React老的架构是利用栈(递归)来完成组件的更新渲染,这样当组件层级较深更新任务较多的时候,js线程会阻塞UI线程导致表现上页面卡顿的现象.React新的架构Fiber中将更新任务进行了<a href=\"https://github.com/facebook/react/blob/f227e7f26b81cb1eba0c837ab2acd7fa7f91404f/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1472\">细粒度的划分</a>并且实现了新的任务调度系统.这样保证了React页面更新的流畅和响应的速度.本文主要从调度React更新任务的Scheduler包入手从宏观的角度了解React中的任务调度机制.</p>\n<h2>前置知识</h2>\n<h3>事件循环</h3>\n<p>javascript中的事件循环可以参考<a href=\"https://icantunderstand.cn/2018/09/17/eventloop/\">事件循环</a></p>\n<h3>isInputPenging</h3>\n<p>isInputPending是Facebook实现的一个浏览器的新的api标准,现在只在最新的chrome版本上有对应的实现.通过调用navigator.scheduling.isInputPending方法来获取当前是否有高优先级的用户输入需要处理,从而实现打断js执行响应用户输入的目的.</p>\n<h2>任务调度的演进过程</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 943px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/08a926bcf0d7610b88cd024eff38d4ba/2b51a/scheduler_long_task.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAG6AD//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAXEAEBAQEAAAAAAAAAAAAAAAAAEQFB/9oACAEBAAE/Id4qv//aAAwDAQACAAMAAAAQc8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAYEAADAQEAAAAAAAAAAAAAAAAAASERYf/aAAgBAQABPxB24lpLzGLhn//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"长时间执行任务\"\n        title=\"长时间执行任务\"\n        src=\"/blog/static/08a926bcf0d7610b88cd024eff38d4ba/2b51a/scheduler_long_task.jpg\"\n        srcset=\"/blog/static/08a926bcf0d7610b88cd024eff38d4ba/0479a/scheduler_long_task.jpg 250w,\n/blog/static/08a926bcf0d7610b88cd024eff38d4ba/41099/scheduler_long_task.jpg 500w,\n/blog/static/08a926bcf0d7610b88cd024eff38d4ba/2b51a/scheduler_long_task.jpg 943w\"\n        sizes=\"(max-width: 943px) 100vw, 943px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span><br>\n当js线程执行一个比较长时间的js任务的时候,会导致UI线程无法快速的响应用户的输入,造成体验卡顿等问题.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/71f0d49fe6d23486141918239a4604af/faa66/scheduler_split_task.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3AUH/8QAFhAAAwAAAAAAAAAAAAAAAAAAABAR/9oACAEBAAEFAir/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAWEAEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQEAAT8huqV//9oADAMBAAIAAwAAABBwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQACAgMAAAAAAAAAAAAAAAEAESExQVGR/9oACAEBAAE/EAlxd53DoPYN4J//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"任务分片\"\n        title=\"任务分片\"\n        src=\"/blog/static/71f0d49fe6d23486141918239a4604af/a2510/scheduler_split_task.jpg\"\n        srcset=\"/blog/static/71f0d49fe6d23486141918239a4604af/0479a/scheduler_split_task.jpg 250w,\n/blog/static/71f0d49fe6d23486141918239a4604af/41099/scheduler_split_task.jpg 500w,\n/blog/static/71f0d49fe6d23486141918239a4604af/a2510/scheduler_split_task.jpg 1000w,\n/blog/static/71f0d49fe6d23486141918239a4604af/faa66/scheduler_split_task.jpg 1056w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n将长时间执行的任务划分成多个短时间执行的任务,能有效的降低js执行线程卡死的状态,这样就引入另一个问题就是如何划分任务切片才能产生更好的UI体验.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 792px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/150e0b4d08aa0861f4343a41e1c4da61/4dfa3/scheduler_continuous_task.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe4g0o//xAAYEAACAwAAAAAAAAAAAAAAAAAAAQIQIf/aAAgBAQABBQK5CeH/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAbEAEBAQACAwAAAAAAAAAAAAABABEhMUFhgf/aAAgBAQABPyHfTfGHfDJ6LLDscl//2gAMAwEAAgADAAAAEIMP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAMAAwEAAAAAAAAAAAAAAQARITFBUXH/2gAIAQEAAT8QU31Z1sLKHX5kQcH2UGzTklACfYqEvfZ//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"任务调度\"\n        title=\"任务调度\"\n        src=\"/blog/static/150e0b4d08aa0861f4343a41e1c4da61/4dfa3/scheduler_continuous_task.jpg\"\n        srcset=\"/blog/static/150e0b4d08aa0861f4343a41e1c4da61/0479a/scheduler_continuous_task.jpg 250w,\n/blog/static/150e0b4d08aa0861f4343a41e1c4da61/41099/scheduler_continuous_task.jpg 500w,\n/blog/static/150e0b4d08aa0861f4343a41e1c4da61/4dfa3/scheduler_continuous_task.jpg 792w\"\n        sizes=\"(max-width: 792px) 100vw, 792px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span><br>\n基于以上两种模式的思路,js如果能在执行过程中主动的获取用户的输入(执行的deadline),主动的暂停当前js的执行并通过事件循环在下一次的事件循环中再次唤起js任务的执行，这样就能充分的利用起所有的执行时间来执行任务并且保证用户输入(高优先级任务)的响应，以上就是Scheduler在调度任务执行的实现方式，下面从源码的角度来看下Scheduler是如何实现任务调度的.</p>\n<h2>Scheduler的实现思路</h2>\n<p>以下源码分析基于React master分支的<a href=\"https://github.com/facebook/react/blob/master/packages/src/forks/SchedulerDOM.js\">最新代码</a></p>\n<p>在React进行渲染任务调度的时候,是通过调用Scheduler暴露出来的unstable_scheduleCallback将任务函数作为callback传入等待Scheduler调度执行.<a href=\"https://github.com/facebook/react/blob/00d4f95c2ad000f40ea0c774cc1ced3a0ceb6f23/packages/react-reconciler/src/SchedulerWithReactIntegration.new.js#L131\">源码位置</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/84f4d/scheduler_call.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.799999999999997%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJklEQVQY022QW0vDQBSE8/9/jPiqeMEnpX0QrGCtF6zdjZu0qdlks0n39kmKikgHhuEc5gyHyWLdELuOoEe1GO3RW0dbe5rtgPeBESmlX/7Mh5B1WvMhc6pyTVUoSrXGbkqGYsXwWRGaithWxBR/j/6G/2dWa83j8wvVWuHkAzv5gFcLvJgRqndi3+BNi7c9ZhfxYQw+/N24z0xr6bsBFyBG8CHt7WGcXdqr6yOuC3Q9DEMiffu8j4SQcD7iXGBsIYs6x6k3xP0ly5sjxPSY4u6UfHpGPjmhmF2jhEStBKUUfI61SEEun5BigVwtKNUr9XZFcFsyZ9dEW2HFLXp+jn2+Qs8vaBaXNPMzmuWEzhTYrsC0it2w2as1Jb3dYJqC6GvAQNR8AbVpy5r5USwPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scheduler调用\"\n        title=\"Scheduler调用\"\n        src=\"/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/00d43/scheduler_call.png\"\n        srcset=\"/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/63868/scheduler_call.png 250w,\n/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/0b533/scheduler_call.png 500w,\n/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/00d43/scheduler_call.png 1000w,\n/blog/static/ca6441d2c8e031ae801366f7f1cb0ed1/84f4d/scheduler_call.png 1208w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n在使用Concurrent Mode的时候此处传入的callback是performConcurrentWorkOnRoot函数，这个函数是React内部调度更新的起始函数.</p>\n<p>以下是Scheduler_scheduleCallback的代码逻辑\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/67a79/schedule_callback.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 112.80000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAADIklEQVQ4y42V6W7cOBCE/RrJSBRJiaduaaSxxxd8rBf7/g/0LUQldgLbcX4UmoDIQnd1detC6BLlA815ZXw806wz7XnCtoH+YSXOA7qy+GFGV4Y8zxBCfIoLISXKOFw/Uq+X1OOIa2qklAhxIM8OZFlG9v0bebaT5Xn+OWEhBJUPDHfPjPcvhGnF1i1lWZHn7x/8iWwnLAoq64nLFe3lbSLbMsmy7DeSv8VFUWwZRrrrB/qbR9r1jIsxlSrEn7P5MENZCJquw3cTflywIWKso1AapaukZZ7lCSIXr/HzkpXGVQYTA7ZtqILH1AE/DYRpxDiLMpIy6D16jSzlh/omwlwqSmsY725pr8501zd012fqZaK/vaVZFqpQoZ1AlgJlJUIKssNhR3Z4bVQuci62gzWG4zwwrgvd1T3Nck3sJ+JwRBtPZSxV6Ci3c1kSg8PEBtP0SSKt9U6a/+hyUUhi9IynkfZ8ot+yPR3prhfCcaadGvzUYZtAPXiayeOGmjD3+KHBxBLtVJIlEW7CK6kwbSRMHWHsCFNPOI6EsU0PXg2eZRxSfF/yqw83OGs4nyamOdL3nmmuca4iFwcK9bVdfvHhTmitZ1xu8f0R9wN+XKlcQJqYbLTN8dbdjwz9k3QvuZDoSqOcQjuNNpoqlCluF7c7YsMXGf5WctM51nPP8dQyLw3Hq555aRnHmmmqccHj+gnfT5TWYdutIcfkBlkUb4SiENjKEkxMM3z49n0XfouHjDxlUHw502/rK8/xMXLz9MJ498Rw/0J3dUd3umG6e04ZxWnXcn9Y/FKmeKfphRIFqpS4psQPIS1WU1eY1uM6iyxzhMrQvkjnQmUJyhRor9BW7dGrNJpJQ6UUvvHEdcTPA2GZqC+PxHWmPk3UU5O+2bbDdWNaxpWpkGprlkgo5B73LouC/rhyevqX5eGZ9fGF0/N/LA//MJ4u6Y6XlNanzV66QOljSuIjXfcuS4l1JdFrvFUEv81rhbeaprG7wX+djsPhXTPe9qEQBBuwpUP7mtLX6WKW5WQ/Y5Z/6b9XQiUlRlcJpQ9pexefmPir/8lG+D+6pI2XBDmakQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scheduler调用callback\"\n        title=\"Scheduler调用callback\"\n        src=\"/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/00d43/schedule_callback.png\"\n        srcset=\"/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/63868/schedule_callback.png 250w,\n/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/0b533/schedule_callback.png 500w,\n/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/00d43/schedule_callback.png 1000w,\n/blog/static/e7a5ba63b1b3fdd71b78b5a7cf0e69f1/67a79/schedule_callback.png 1408w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n在unstable_scheduleCallback中主要做了如下几件事:</p>\n<ol>\n<li>根据传入的执行函数和优先级创建执行任务，加入异步执行队列或者同步执行队列</li>\n<li>调度任务更新</li>\n</ol>\n<p>以下先只关注同步taskQueue的执行流程,requestHostCallback通过Message channel发起宏任务来执行flushWork,最终走入到workLoop整个调度的<a href=\"https://github.com/facebook/react/blob/00d4f95c2ad000f40ea0c774cc1ced3a0ceb6f23/packages/src/forks/SchedulerDOM.js#L200\">实现逻辑</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 733px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/698bc99b2ece9e667db04ba2c3e361f0/00b70/workloop.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 131.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD9UlEQVRIx42Vy27dNhCGz1sEjSXxTlGi7jo+Olc79zRANl0UfYsWBYp20V374F8hyY6dxEG6+DEUIQ5n5p/5udFGYIKnOjTEqUfnAWUcNpTYvEBKSZokK9KELMsQQnyF+/2NNorpuOP46sR02jJOI/3xTHfzhtiPn37O7u13sFFS0bcT/e6CawaqqiBUNaHp8UW5/HQf3QPSb2IjhcDmOf76jN/dYPsJ2U648YirOvKiIHQjoe3J24G8atdL0vTpCKWShDygrScVklQqshnGIYxHSIXQdoE0FmXMGs23Up6LrpWm3R3pLm/ozi9pTi+J447heKS/HuinHdc3F8ZpjzWGJEm+cnQf8RKhMQYXAjZGfF3jmxrjHc4oiuDIvV2s0Zo0SZ/EvdPN3DZSKnxpCYPFd5py5/CdRVqB0ALp5GqtRFmJ9gqdK5STmKCWvYcI5RphWzTkzpOJFCEzhJydSTK5OhVKIB/ZT2uz2kcOBcYHhI+koUFWA9oHXGwp24EQK6phh/WB5OrqIc00u8O6/owUqy31/pb69gPx9Ip4+57hdENdN2zHLVUV0cYuzT2zPh9Mrp6TJFdLj84XLZctfSglUmuK6xP15S3V5R3V5S3x/Aa7PROmW6rdifb0kub4gvbyiridcLHBlxXW57hY46sWqRQbpQVKKeq2ZNw39IcR148U0558vMb3PXGaqHYTWmvUDGPR1i3npNJoly9lm8ldWVYa1/aUhx3l+UA8TFSnifK4p51adueG7alDVANp0SKKBhl7ZL3FOH9X2+QhZaU0sdsRj69x44nmsKI9X+jPN8S6pfSOGHLKEDA+J1NmnSApybKHMdxoK5BCorTCthWuqzFtjR86TF0g65rMBuQsaXO9vEeK7JGkPTT1EuFcB5EJuqHn8uqW/WXP9jDRnF5Q78/4cb8IR3F6Tdi/QIaK7ItZfiwUGy0lQkmaENkOW8qZkG4kL0qapqRqW0K/pahb7DJ6V3fO0icVZ9FDIeQyp23fUm6PVLsz1nqMlhhrUS5fmJ3FNn0iqs8dKrnQb/06u/MoKTfPbUaaJQ8MflGvbyu2EYt89dtqaY9hKmkOHdXxmri7Rt/pX/adyD45nNO11jD1A1XTkccapRxpki2lWNNM/9d7srA8H/Ah0I4jxfawCGtVx0UgbIgobR4JwiObfr13l7LF5gETI7Yssd5QtYHQtYRhiyvmHpRIo5B6tbOszZ2x7qnFrq+imEkROJMSWkveePLa4aPC1RofEqT6AVem2JCg3dWyNvm6nvfMbIuE7OoZ6fNnbOyPvxE//kX/8z/EX/6l/Olv8o9/4D7+if/wO+bdr+i3v6LffQ7z5ff7Ff8BGwXxHBeZuTwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"workLoop调用\"\n        title=\"workLoop调用\"\n        src=\"/blog/static/698bc99b2ece9e667db04ba2c3e361f0/00b70/workloop.png\"\n        srcset=\"/blog/static/698bc99b2ece9e667db04ba2c3e361f0/63868/workloop.png 250w,\n/blog/static/698bc99b2ece9e667db04ba2c3e361f0/0b533/workloop.png 500w,\n/blog/static/698bc99b2ece9e667db04ba2c3e361f0/00b70/workloop.png 733w\"\n        sizes=\"(max-width: 733px) 100vw, 733px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span><br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/0f586/yieldTimeout.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 92%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACs0lEQVQ4y4WU2W4cNxBF9RlG1NybO3ubGY2txWNY8Ev+/4NO0GxFseEkergokkAfXNYt9l2KEeUiqS2cHzY+P125XM+cdz1slJJxsWLdiBQC8YHuaq1IqQjTRn7+Rry9Mt5+UL488fT9kfOXE+enK/M6oaxCGoXUCm0USu+Sh+yxvvMxEoRg0gNTFMxRMgfBmgRbVX2/BMGSFFuznKthqhZbLb45xl3V4rJFGXUA0yAoKZJOE3GOjEvGLg3tPWOI+FIYU0Jbi5OCogSDlCgl312+XznXShzuyW3DXV4Qp0c+Xb/z6fINOV+IywO+rbiYkcaih4F0PzAI+VtPpZTcpZzx+5XVwDTuV9OsWbMEyZo00yhpZqDZgeYkq1dkr7HZYoPpMl53WHe4p7xvzKgPuaNab7pkd/KmQSCGN0fD7wl3hznnA+gUYzWMVffqksZlg58cLpmj+c3h57GfhWVkrK4H09fNHQ5LKQfQj5TrzHw7Ux4afor4OeFnh02mw8Ps8Hu6k+va0x2LwTeLtuoAxv3KQhBCJc0n/LQyxoIdPS5ErNGYNwltGbRFKIOQGiHVsdf2px6mhJSCGBOnyzPTdu2wWgLzlFmWQq2R1jKyLPzRTtzXE0OaECFzv9eyYIx5eymldvpoHcu0sT5/pTxcia0grUQogTT7S5Boc/S6y2u0U+j93Kq+7qEcT28fUtWbX7ZAOyema2b5XChrJFVPrB47mgPyNgkHUL3X7jCEcIRiDGub2OZGDI6SAyV78l5LIMWA0YZhGI6R+Rf9MjZaKebrC+fXP1luP5hfXpkeb4x1wbbzL7P2X/rpbyMZnUM7h/Wxp2t6ygltLMq6fz76H2B3uI+N1ppWZlIsB8AYlNbHx3pPb3h395HLA6gUPlfydiGtZ+JyIrSluzWxIJX6EPQ38C/i5f+uoA5LswAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"任务过期处理逻辑\"\n        title=\"任务过期处理逻辑\"\n        src=\"/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/00d43/yieldTimeout.png\"\n        srcset=\"/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/63868/yieldTimeout.png 250w,\n/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/0b533/yieldTimeout.png 500w,\n/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/00d43/yieldTimeout.png 1000w,\n/blog/static/0f8e2a77fb4e9e1c3bb8a3bda58434ff/0f586/yieldTimeout.png 1498w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\nwookLoop是实现任务调用的核心逻辑,它主要实现了如下几件事:</p>\n<ol>\n<li>对可执行时间进行了切片(yieldInterval == 5ms)</li>\n<li>当超时可执行时间后,进行任务队列的调整在下个事件循环中唤起任务调度逻辑.这里有区分的是同步任务队列是直接通过postMessage发起调用,延迟任务队列是通过timer(setTimeout)发起调用.</li>\n</ol>\n<p>抛开源码可以简单的理解Scheduler的调度任务实现思路如下图,它正好实现了任务调度切片,优先级,高优任务插入等逻辑.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 984px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/d056dfc402ef23dd6cb937078e3b9073/f30f2/how_scheduler_work.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 99.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe9INAQKD//EABcQAAMBAAAAAAAAAAAAAAAAAAABIDH/2gAIAQEAAQUCFl//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/Ah//xAAaEAACAwEBAAAAAAAAAAAAAAABIQAQETFR/9oACAEBAAE/ITyelNuDcVGDlf/aAAwDAQACAAMAAAAQMwc8/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHBABAAICAwEAAAAAAAAAAAAAAQARITEQUWGB/9oACAEBAAE/EN1dRqHbhBk0fNTqPsLrNQYmPD//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scheduler整体的思路\"\n        title=\"Scheduler整体的思路\"\n        src=\"/blog/static/d056dfc402ef23dd6cb937078e3b9073/f30f2/how_scheduler_work.jpg\"\n        srcset=\"/blog/static/d056dfc402ef23dd6cb937078e3b9073/0479a/how_scheduler_work.jpg 250w,\n/blog/static/d056dfc402ef23dd6cb937078e3b9073/41099/how_scheduler_work.jpg 500w,\n/blog/static/d056dfc402ef23dd6cb937078e3b9073/f30f2/how_scheduler_work.jpg 984w\"\n        sizes=\"(max-width: 984px) 100vw, 984px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>参考链接</h2>\n<p><a href=\"https://engineering.fb.com/2019/04/22/developer-tools/isinputpending-api/\">isInputPending的实现背景</a><br>\n<a href=\"https://web.dev/isinputpending/\">isInputPending的使用思路</a><br>\n<a href=\"https://someu.github.io/2020-11-10/react-scheduler%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/\">react scheduler源码解析</a><br>\n<a href=\"https://react.iamkasong.com/concurrent/scheduler.html#%E6%97%B6%E9%97%B4%E5%88%87%E7%89%87%E5%8E%9F%E7%90%86\">React技术解密</a></p>","frontmatter":{"date":"2021-03-15","path":"/react-scheduler","title":"从Scheduler包来看React的任务调度"}}},"pageContext":{"readingTime":"5 min read"}},"staticQueryHashes":[]}