<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/blog/styles.8c2a65503dd1228c0d48.css" data-identity="gatsby-global-css">.blog-post-content{margin:0 auto;max-width:960px;padding:0 1.0875rem 1.45rem}.blog-footer{align-items:center;display:flex;flex-direction:column;justify-content:flex-start;margin-bottom:30px}.paginate-container{align-items:center;display:flex;flex-direction:row;justify-content:center;margin-top:20px;padding-bottom:10px}.paginate-item,.top-post{margin-left:10px}.top-post{color:#1e80ff;display:inline-block;font-size:15px}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;box-sizing:border-box;font:112.5%/1.45em georgia,serif,sans-serif;overflow-y:scroll}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;word-wrap:break-word;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:georgia,serif;font-kerning:normal;font-weight:400;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent;text-decoration:none}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help;text-decoration:none}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}img{border-style:none;margin:0 0 1.45rem;max-width:100%;padding:0}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace;font-size:1em}hr{background:rgba(0,0,0,.2);border:none;box-sizing:content-box;height:1px;margin:0 0 calc(1.45rem - 1px);overflow:visible;padding:0}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}*,:after,:before{box-sizing:inherit}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem}ol,p,ul{padding:0}p,pre{margin:0 0 1.45rem}pre{word-wrap:normal;background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;overflow:auto;padding:1.45rem}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;margin:0 0 1.45rem;padding:0;width:100%}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,noscript{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}td,th,thead{text-align:left}td,th{font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}</style><meta name="generator" content="Gatsby 3.15.0"/><style data-emotion="mantine "></style><title data-react-helmet="true"></title><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/blog/favicon-32x32.png?v=1a4023285f20ec8ca43a96875f92c5b2" type="image/png"/><link rel="manifest" href="/blog/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/blog/icons/icon-48x48.png?v=1a4023285f20ec8ca43a96875f92c5b2"/><link rel="apple-touch-icon" sizes="72x72" href="/blog/icons/icon-72x72.png?v=1a4023285f20ec8ca43a96875f92c5b2"/><link rel="apple-touch-icon" sizes="96x96" href="/blog/icons/icon-96x96.png?v=1a4023285f20ec8ca43a96875f92c5b2"/><link rel="apple-touch-icon" sizes="144x144" href="/blog/icons/icon-144x144.png?v=1a4023285f20ec8ca43a96875f92c5b2"/><link rel="apple-touch-icon" sizes="192x192" href="/blog/icons/icon-192x192.png?v=1a4023285f20ec8ca43a96875f92c5b2"/><link rel="apple-touch-icon" sizes="256x256" href="/blog/icons/icon-256x256.png?v=1a4023285f20ec8ca43a96875f92c5b2"/><link rel="apple-touch-icon" sizes="384x384" href="/blog/icons/icon-384x384.png?v=1a4023285f20ec8ca43a96875f92c5b2"/><link rel="apple-touch-icon" sizes="512x512" href="/blog/icons/icon-512x512.png?v=1a4023285f20ec8ca43a96875f92c5b2"/><link as="script" rel="preload" href="/blog/webpack-runtime-7cf8a12991354380b805.js"/><link as="script" rel="preload" href="/blog/framework-30c1cbcd4309881b11c5.js"/><link as="script" rel="preload" href="/blog/app-d0ee19b1d8c6e2977e87.js"/><link as="script" rel="preload" href="/blog/ef6529d7-5809e26836cfb9703dbc.js"/><link as="script" rel="preload" href="/blog/a26abbfb03f25b9cd2b611d1d937ab5e796b3999-b150e4ff1a4c20fff1a0.js"/><link as="script" rel="preload" href="/blog/6ba5cc0c8669d68fb0f844125a981d8f12367a97-80c1b264a8cd3e0a6a03.js"/><link as="script" rel="preload" href="/blog/component---src-templates-post-js-51ecaadd78c143c3f12f.js"/><link as="fetch" rel="preload" href="/blog/page-data/react-setstate/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="mantine-AppShell-root mantine-1272lc7" data-barba="wrapper"><header class="mantine-Header-root mantine-10euv7e"><a href="/blog/"><div class="mantine-1ln4pgh"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-ghost" width="30" height="30" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M5 11a7 7 0 0 1 14 0v7a1.78 1.78 0 0 1 -3.1 1.4a1.65 1.65 0 0 0 -2.6 0a1.65 1.65 0 0 1 -2.6 0a1.65 1.65 0 0 0 -2.6 0a1.78 1.78 0 0 1 -3.1 -1.4v-7"></path><line x1="10" y1="10" x2="10.01" y2="10"></line><line x1="14" y1="10" x2="14.01" y2="10"></line><path d="M10 14a3.5 3.5 0 0 0 4 0"></path></svg><div class="mantine-Text-root mantine-1pbxw0k">noodles的笔记本</div></div></a><span style="transform:translateX(-100%)" class="mantine-1y53kbb"></span><style data-emotion="css-global nn3xf4">:root{--mantine-header-height:70px;}</style></header><div class="mantine-ibbm6b mantine-AppShell-body"><main class="mantine-d5iwcx mantine-AppShell-main"><div class="mantine-1w0809u"><div class="blog-post"><h1 class="blog-post-content">setState源码分析</h1><div class="blog-post-content">5 min read</div><div class="blog-post-content"><p>在使用React进行业务开发的时候setState可以对组件的数据进行更新并且触发页面的渲染.本文从源码角度梳理在调用setState的相关处理逻辑.</p>
<h2>前置知识</h2>
<h3>React多平台渲染</h3>
<p>React在设计上使用了依赖注入的方式,通过注入不同平台的渲染renderer来实现多平台的渲染能力.
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/blog/static/9bca1c5b0e82f7200da7c0c3d9f20d54/5c744/reactRenderer.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 85.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAABg0lEQVQ4y5WUiXKDMAxE+f/fZLivHBBu3HmiSyCFdsrMxrItrVeyHG+aZjdNk2EYhg37ed/3bhhGWxvH8Xv+9tvD42dZFvd8Pl1RFO5+v9tYlqWhqip3u91cnucWwBwbvziOjXSeZ8OBEIfH4+GCILAAwDxNU5ckiZGiTERRFNmeCDeFTCB8vV7mjBMq6ro21aiUcvyaprG1LEttpAQHhTK0qJRQByFqAAegEmL2sed5+VnDvVzZpNZ1nQX5vm/AZo09sBexjz0QrlhLQG1QI3IUY7O3J7pU+Jm6LqBtWwM2xErzLO5C4Tt9LoBLAthXvr8qlI0qLkKE2HQCKf9LIW1AEJdAW1A72Yzs4fOnQp1CAB+K9EoYAW3Eh8+VUk9kfKQEAYHquTAMDdgiZY8D+U4VkgKOPDs9M/UhTwxg00qUgEbHl0NOXwqOWZYZKQEokVrmSp/gtQSl+XL46VtmkaJD0rYrkd72utZuhPoTYY03fvpvA1CBM8DG4WxNTQ4p+KzhFxiCKgcyB0LkAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="react renderer"
        title="react renderer"
        src="/blog/static/9bca1c5b0e82f7200da7c0c3d9f20d54/00d43/reactRenderer.png"
        srcset="/blog/static/9bca1c5b0e82f7200da7c0c3d9f20d54/63868/reactRenderer.png 250w,
/blog/static/9bca1c5b0e82f7200da7c0c3d9f20d54/0b533/reactRenderer.png 500w,
/blog/static/9bca1c5b0e82f7200da7c0c3d9f20d54/00d43/reactRenderer.png 1000w,
/blog/static/9bca1c5b0e82f7200da7c0c3d9f20d54/5c744/reactRenderer.png 1206w"
        sizes="(max-width: 1000px) 100vw, 1000px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
在创建组件实例的时候,React会注入不同平台renderer最后结合react-reconciler来实现组件的渲染更新.</p>
<h3>事件循环</h3>
<p><a href="https://icantunderstand.cn/event-loop">事件循环</a></p>
<h3>lane</h3>
<p>在react新的架构中定义了lane的概念.lane用于控制不同任务的更新优先级处理逻辑,具体可以参考<a href="https://react.iamkasong.com/concurrent/lane.html">lane模型</a></p>
<h2>源码梳理</h2>
<p>基于React的多平台渲染架构,在梳理setState源码是从以下两个方面进行的:</p>
<ul>
<li>注入渲染renderer(setState从哪里来)</li>
<li>发起调用(setState做了什么)</li>
</ul>
<h3>注入渲染renderer</h3>
<p>在<a href="https://icantunderstand.cn/react-render-interpretation">图说React渲染流程</a>中,React会根据当前的页面结构创建workInProgress树,注入renderer的逻辑就在创建组件实例的过程中.
在创建<a href="https://github.com/facebook/react/blob/a423a01223785a8bc4dcd55f2a0288200b033eee/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L943">类组件</a>的时候,会执行constructClassInstance创建组件的实例.
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 724px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 82.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACeUlEQVQ4y42T247bNhRF/RuxRPFOUferZXuMMdpBmiAPyUOemqekLfr/n7AKyc5MGwRNHjb2JiQungMe7jIpcc1IHE8My8BwHJhOE93cEnNPlmUIITb/Ge0yISjHhf76muZ4oTssNEOLizn7V/vnH38WuhNpSnv5lfOH3xmuT9SPJ6R3rAet1X+74UfgnVGKEAtsHrEh39r0uSdNEtJkf/eEZP8KIdIfQnd6DcYhpEasrh3GOlxR4coamxe4WJK3A9qY/4Wt33ZZJvD1RPnwRPP2I9Nv76mmI7GfyOv2BiyqO9A+A1f/Xt5JKQnaUtQ9+eFC1fX4siXUPVYrkue2999t+VvwBtRao60i1B5fO0LrCN0t+8ZiosGVFl9bXGXw7S2bqHGlIR89tjT/AhqNcpJ8tITeEjpLPjri7MmHFe6Io6dYAnEKFHPYgF8PWGFrESbolwp9WVEtR8pxpDwsxK7F1S3aWZRRKCNRWm6+tZekiESQJinp5uKlQrUCu57q4bKpXBbifKA6n3BNjS4qpFVkViFWaNBIpzatWTmFdur+UjJJNIa+rpkPh01D1zLPM0NbUg3TdutVDESTEbWkcOse+ZztWr29A7XMaNYqjcZ4g3Gr6829TIk2JTerBEHdsxbkKiUYQakzYpKSiK+DbQQHnfLpMeXzk+DLG8Uf7wyfnwxd3+D7kdB2+KrePO8HbFHgm47Q9eTeUayjIyXy9pYF5+j46+3C3+/O/Pl65MsvHZ+uE9fjA+fjI6dx4TguXE5XjsNhy+fDA8dh5tSODN2IzfNtTrdLKaqGUM2E/oQdz6hmQsYWFSJaydtwp8lda05f1iL9z0v5Bw9BzFQeJzKMAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="constructClassInstance"
        title="constructClassInstance"
        src="/blog/static/497d1ecebae05943263e87a1e98aa231/a242d/constructor.png"
        srcset="/blog/static/497d1ecebae05943263e87a1e98aa231/63868/constructor.png 250w,
/blog/static/497d1ecebae05943263e87a1e98aa231/0b533/constructor.png 500w,
/blog/static/497d1ecebae05943263e87a1e98aa231/a242d/constructor.png 724w"
        sizes="(max-width: 724px) 100vw, 724px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
    </span>
在<a href="https://github.com/facebook/react/blob/a423a01223785a8bc4dcd55f2a0288200b033eee/packages/react-reconciler/src/ReactFiberClassComponent.new.js#L591">constructClassInstance</a>中主要做了如下两件事:</p>
<ol>
<li>执行构造函数,创建组件实例</li>
<li>注入组件更新逻辑实现</li>
</ol>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 642px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/blog/static/1432b8761f07738688fa565358af68b7/1bba8/executeConstruct.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 48.800000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpUlEQVQoz42S7W7bIBhGexmrbcAuBvwBCeQ7Wbt0bZJqSqPe/9WcyY4qdVun7ccR/Do878N7I8qKqkuUbeTb84GXyxvH1wuny4XT6ys/3t6YpkSe50gp/8mNEAK/vid8fWR5OrM9nFk87Nken4mLFSHOqI1BFMX/CYs8x853uLSiWyaElGRfbsmzbCTLbin+kAmE+IuwLEtsSkzuN/QTizaKUiuqWo6phgdHipwiy8ZTfCIaJh2FsqywXUeTeuwq4jYzmnlPs5yimxbbB0zn0dZh/ITaOqQQo+Aj79IbKQp03KH8EjVdU0+X+Pkav30i7k8sD2dm+yPx8cT8cGb+/QXjGpRSSFVe+SWhlNzVNXVao3dHms2e+PBEWm9RztP1ntpPKeMG7RPtfI1rW0wXKP2Cqk/I8u6adBAqJamqikpr9GyLmSSUtlTGXTsbyDPE0N3AeC+uid75+CmyLAixI20Ci8fI7jCj7wzWOayfXukDd8aibEvVTdC1uQqGsaX6TSglIXQE39C3lq51hNDQeI8NEesnuBDRQ2+uo+oj2phxdT5bm59BfiES78o9rwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="执行构造函数"
        title="执行构造函数"
        src="/blog/static/1432b8761f07738688fa565358af68b7/1bba8/executeConstruct.png"
        srcset="/blog/static/1432b8761f07738688fa565358af68b7/63868/executeConstruct.png 250w,
/blog/static/1432b8761f07738688fa565358af68b7/0b533/executeConstruct.png 500w,
/blog/static/1432b8761f07738688fa565358af68b7/1bba8/executeConstruct.png 642w"
        sizes="(max-width: 642px) 100vw, 642px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>在<a href="https://github.com/facebook/react/blob/a423a01223785a8bc4dcd55f2a0288200b033eee/packages/react-reconciler/src/ReactFiberClassComponent.new.js#L581">adoptClassInstance</a>中在实例上注入了updater实现了组件的更新注入能力.
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 758px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 32.800000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABRElEQVQoz1WR0XKbMBBF/R1FQkICIYSREGC3rk3cpk3+/49OB+xk0oczV/tyZnX3UBqLDok29ixLT54C849Imnt8ytRpweUzNgzUsacOnjZO+HGmOQaabZ4idVMjheCgjcLnkeHnzHDOhCVzunT8XQO3qeeaPesycB4ctTHYqkLpB6aqMFrTGINSirIsOWitidcX8u838usbw3VleVn59f7K5XZi/XPndr+QBocyCmXVntsi2j5Qz5RSPoRp9KSpI06Bboy0OWGPAZdHmjHjUkQbidLiM1UlqRq9Y565C1VZEodEvL9z/H6jn057R12a8TsTTddThYRqjw/8gHYdUsj/2L9srcE2DuM8la0xrsW2Htt2O9ust47agHLdk4Bu2l3wlX1DY7dCS0Txbb+SEAWi+IIokFIgiwIpnny8pfwUfUj/AfXDysLcW3bxAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="注入updater"
        title="注入updater"
        src="/blog/static/0ec8d69c0ef510e14f1fdd507ed5c0af/c8e86/adoptClass.png"
        srcset="/blog/static/0ec8d69c0ef510e14f1fdd507ed5c0af/63868/adoptClass.png 250w,
/blog/static/0ec8d69c0ef510e14f1fdd507ed5c0af/0b533/adoptClass.png 500w,
/blog/static/0ec8d69c0ef510e14f1fdd507ed5c0af/c8e86/adoptClass.png 758w"
        sizes="(max-width: 758px) 100vw, 758px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
    </span></p>
<h3>发起调用</h3>
<p>在组件的实例化过程中,注入了提供更新能力的updater.调用的逻辑其实就是梳理对应的updater如何触发页面的更新.通常调用setState是如下的方式:</p>
<pre><code>this.setState({  })
</code></pre>
<p>setState是挂载在组件实例上的方法,在创建类组件的时候会调用React<a href="https://github.com/facebook/react/blob/a423a01223785a8bc4dcd55f2a0288200b033eee/packages/react/src/ReactBaseClasses.js#L20">类组件的构造函数</a>来初始化实例.
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 723px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 57.599999999999994%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB70lEQVQoz22S6XLbMAyE/R6WRPDWQdm6bCdO4jTt9P0f6euI8tiTtj92FiAxywXAnU8G7RXaCcYLJghiq4z13ER5xGIl19nWZC7LkqqqvmFnmog4iwoGaRwSLMp5bAz41GLrQOgTfq0zCqW3x1f+WywLSrcQlxv97Yt4vpCuP7FpxoYG1/RYXxP6CesCVVlR7MsHyuKO8sk7XXfU84nxdiPNR/qXF7plRtvVTYnSFUo2Fre1LFahg87xlm+8OQwB23WENuKnAT2fsdOMbTzaKbTfitcHdJ7xXcjLP3kW1NFRzw3dpcOniO1qXKpxjWO9c31AR4uJDhNtdpZFVsE1rvVDfHPoIr470C5njPPEfiB0B4z1qG5C9SfkeEEOJ0yaUEooi+I5t+L7LHc6Bipn0dZhfMyiJkRMCJm182htENkcVKr673afW+47VLu2mIiHCd/2mdfNNtM55946rDEU+z3Fvrhj/+0fZsfZ4ZgwQ0s8JprlRDMODGPNcawxwaHbhD8OtPNEuyy0y0w99PQvr6RholKKongK72zf071dGH9+Mr2feP0xc/2aef81M1xn4jLRX88cP64cP95I55H5943x80qKgaEJtDGg7iPZxbqhLAXRDlGC0Ru0SM4rpVErxGyoJPN6LqrCrrVaHm3/AZ0jV2qMuOQFAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="baseComponent"
        title="baseComponent"
        src="/blog/static/2ae56cda731fe7c84a8d82990745f055/c67d4/baseComponent.png"
        srcset="/blog/static/2ae56cda731fe7c84a8d82990745f055/63868/baseComponent.png 250w,
/blog/static/2ae56cda731fe7c84a8d82990745f055/0b533/baseComponent.png 500w,
/blog/static/2ae56cda731fe7c84a8d82990745f055/c67d4/baseComponent.png 723w"
        sizes="(max-width: 723px) 100vw, 723px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
    </span><br>
在调用setState的时候其实是调用注入的updater(classComponentUpdater)的enqueueSetState逻辑来实现页面的渲染更新.
在classComponentUpdater中主要做了:</p>
<ol>
<li>创建update 形成update的链表结构(updateQueue) 在更新阶段会依次处理链表的update</li>
<li>通过scheduleUpdateOnFiber触发更新</li>
</ol>
<p>在<a href="https://github.com/facebook/react/blob/a423a01223785a8bc4dcd55f2a0288200b033eee/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L456">scheduleUpdateOnFiber</a>中获取到根节点通过ensureRootIsScheduled发起根节点更新调度.</p>
<p><a href="https://github.com/facebook/react/blob/a423a01223785a8bc4dcd55f2a0288200b033eee/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L632">ensureRootIsScheduled</a>的功能是在根节点上调度任务的执行,主要功能如下:
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 759px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 125.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD+klEQVQ4y32V2W7cRhRE9RnJDMneSPbG5q7ZR5a8JDYMBHnK///JCUhNZFm281DongFYqMuqW7yTpUWFhBsb5nPL7tJzfNdxOiWGNmBjom4CfmwxtsbUjtIFSudwfcJ6hxCCPM8py4o7qRTaR6phpAiR3Do+7Cv+Piq+ToJKFWSbLWK7Jc8ysmxLtty3W4rbfwtZURTreSeKgjokmvmAdR7fz/huIkx7bOqpfMSNO2w/44Z7/LRfT9dPGB9R3Q5Z+5V4Ib0rhUS7BlEHZDOg2hnZjAiXqKyl7TxDH+m6Z6Q2UlbVi6r/sPzOF0IlBFUcMNMFffiAuXzGnP5A799TT0fSOJGuT7SPn1akyyNxmF4UrUSvR1Y2YJQknhLtx5F46fCHlnBu6Z5a4j5g+kg1J6oxUo0BZfRPFa4jS2MwStNYjykleb4hz7cImaNKgVBiNeA7vCF7jTtVLlEocb3DthbbLXGwGK/INhn5ZkOe3dxcHf025s+wxsb6RHr6RPr4hf7zX8SHpzV7dVxcnFFpRDWL4x6pnlULuaCgEMV6rvdVofVIUSCtRjclJpXoaKiHGjtZ7D5Qzw6789jRop1c1RsvkZXAOPWMoJFacCetR2vJcIpMDw3jNTJeIuO1YbhEpmvD/JiYHhLd3uM6T9Va4j7hR7eSLypfTFnWpi5Ldqc9+w+PzA8Xdo8PzOcTqfU0raNJjhBqQqiwwSPLmirc8ljkb1yWEikkLtR0UyQuBL0nNJZmUdLWpM4RfI3Wmu1qUsZ2s6xg9mMOl5drTMn9MDDdt4RUEzuHjZbQOkLniL2nGQJlXa4PSvlsirxBiDcKlZI0yTLMka539FNEDztUN6LHe9QwI1NH4RqcqxiHQNt6hiEyz4kY3Zt3aD2u6akXdBOq8hTGkmX5OlaWCwqpKJRekQtJIeVKkv3QNkIQm477658MT19JX/7BXz4xvv9Id76yO0w093tEM6LStEKEltI3yKUHfzBFCJZwh8OZ4fE9/fWR8XplPB0Zjgd8ainrmrKqKdaN2VLctubtHt9Mkdi6JpYaq3NqnWFNQaUFlZFIbSiUQVf1bcQbbvfXZDdTBNYuJXpFzVfk/IDoj4g0U/iesirpF5cbS9cHpqmh7+OazSWny/Ovy2IdecnX8l1RsUc3A9I16NoilURptaZgjYl4HZVnvFb34nJZW+LhgXh8t56uG5iOO/oh0XUe758dz4ufN813Iy+ExhjaeWa+nOl2M/1+x/3lxDT3a95i1yIrj2uHdZpfletz22iDMRqpljz9Rp7/TlFsEGLBUqibb7j1YVHkvyzZO2mqtffSeSad98TDTNwNuClR7eb1wyVDh/QJqfT/tvVC+C8D+9HyjMLmcwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="ensureRootIsScheduled"
        title="ensureRootIsScheduled"
        src="/blog/static/df31f836b5cc428cf2864f9bdd7254d1/ef3e1/ensureRootIsScheduled.png"
        srcset="/blog/static/df31f836b5cc428cf2864f9bdd7254d1/63868/ensureRootIsScheduled.png 250w,
/blog/static/df31f836b5cc428cf2864f9bdd7254d1/0b533/ensureRootIsScheduled.png 500w,
/blog/static/df31f836b5cc428cf2864f9bdd7254d1/ef3e1/ensureRootIsScheduled.png 759w"
        sizes="(max-width: 759px) 100vw, 759px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
    </span></p>
<ul>
<li>根据当前任务获取优先级通过Scheduler发起不同优先级的任务调度</li>
<li>同优先级任务合并,不发起新的任务调度</li>
</ul>
<p>setState是SyncLanePriority优先级,在调度上就会通过微任务发起调度逻辑等主代码块执行完毕后开启微任务执行(调度更新)</p>
<h3>图解setState更新逻辑</h3>
<p>假设我们在这样一个场景中在一个函数中连续调用的两次setState</p>
<pre><code>this.setState({  })
this.setState({  })
</code></pre>
<h4>第一次调用</h4>
<p>在第一次调用setState的时候在fiber的根节点上创建了updateQueue添加此次的更新内容,通过微任务发起调度.
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/blog/static/00a176694c87a68e767f39aea74c21fa/61016/setStateFirst.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/0lEQVQoz41S266EIAz0/3/TC8YLRBBBFLuZrt24J+6efZhAUzqdTin2fadt2xg5ZzqO4wXkBMjdvc3InXmgWJaFjDGktebTe89A3LYtNU3DMYpTSvzGWkvDMJC3lqwxNGlNKYQnYQiBi7uuo3meuQgAyTiO1Pf9G+E0TeScY9I1BPLOMVKMT8IYIxdCDch5jHMcxFAk4wLSkG242CNveGQoxAhQKF6gkVIt1XXNisRTyV/9vaK4Gi1mA+u6sjqoR9NvJG+EQnDtLKcsDI1+IXspvPse1jpegFgRzi1+J8yfCZVSVFUVlWXJd5D+/ZsfFOZbQiwCJADu8fwW/yl8AGbIDaEzSvt9AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="setStateFirst"
        title="setStateFirst"
        src="/blog/static/00a176694c87a68e767f39aea74c21fa/00d43/setStateFirst.png"
        srcset="/blog/static/00a176694c87a68e767f39aea74c21fa/63868/setStateFirst.png 250w,
/blog/static/00a176694c87a68e767f39aea74c21fa/0b533/setStateFirst.png 500w,
/blog/static/00a176694c87a68e767f39aea74c21fa/00d43/setStateFirst.png 1000w,
/blog/static/00a176694c87a68e767f39aea74c21fa/aa440/setStateFirst.png 1500w,
/blog/static/00a176694c87a68e767f39aea74c21fa/61016/setStateFirst.png 1770w"
        sizes="(max-width: 1000px) 100vw, 1000px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h4>第二次调用</h4>
<p>第二次调用setState获取的更新优先级跟之前任务一致,这次只进行updateQueue逻辑增加任务的操作<br>
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/blog/static/76f16d8aefefa3d39948c2f406cdc6cb/b6e50/setStateSecond.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 66.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUElEQVQ4y5VTa6+CMAzl//9BEz8J4SWMMQGBjY3enGrRq3gfS5qWPk572hB578laS/M8k3OOQgi0ritrax3Lsiz8DY08iNRAIyYSAdC0LSmlqO97diKx6zrK85yyLKNhGLiJ1ppzLpcLlWVJ1+uV6xCHfxzHG2DbtreEYWBAYwwnAaCua26A6WAjhnzEqqpiIMTADjryIWyAmGqaJu6Mh46IoSkEMfggYsP/TtkY7giNRNlVmqaUJAlPIXsVHcLKtjQTibwPW+JKtBUAFA2wI1n8a/G7BIok0eJ6dwoQPAABFO93sCdAZy1VZUlFlpFWineI/RRFQefzme09ej8CAqhRNRmt+WJN0/AO87xg+5Xy3jcfRQK8wyfBDkEZx4J+BfkIuDc6T+0cnU4nOhwO/6B8v/InwDiO6Xg8MuDfruwflB80wlYMUPkDxPddhzfKX/ab9wsUR/UWAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="setStateSecond"
        title="setStateSecond"
        src="/blog/static/76f16d8aefefa3d39948c2f406cdc6cb/00d43/setStateSecond.png"
        srcset="/blog/static/76f16d8aefefa3d39948c2f406cdc6cb/63868/setStateSecond.png 250w,
/blog/static/76f16d8aefefa3d39948c2f406cdc6cb/0b533/setStateSecond.png 500w,
/blog/static/76f16d8aefefa3d39948c2f406cdc6cb/00d43/setStateSecond.png 1000w,
/blog/static/76f16d8aefefa3d39948c2f406cdc6cb/aa440/setStateSecond.png 1500w,
/blog/static/76f16d8aefefa3d39948c2f406cdc6cb/b6e50/setStateSecond.png 1862w"
        sizes="(max-width: 1000px) 100vw, 1000px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h4>更新任务执行</h4>
<p>微任务执行,开启更新逻辑</p></div><div class="blog-footer"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper gatsby-image-wrapper-constrained"><div style="max-width:344px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg height=&#x27;344&#x27; width=&#x27;344&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#f8f8f8;position:absolute;top:0;left:0;bottom:0;right:0"></div><picture><source type="image/webp" data-srcset="/blog/static/fea72b8bb6c1352a510a256c539d4702/ff4dd/qrcode.webp 86w,/blog/static/fea72b8bb6c1352a510a256c539d4702/d6c07/qrcode.webp 172w,/blog/static/fea72b8bb6c1352a510a256c539d4702/0f0fa/qrcode.webp 344w" sizes="(min-width: 344px) 344px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 344px) 344px, 100vw" decoding="async" loading="lazy" data-src="/blog/static/fea72b8bb6c1352a510a256c539d4702/6ee52/qrcode.jpg" data-srcset="/blog/static/fea72b8bb6c1352a510a256c539d4702/8025c/qrcode.jpg 86w,/blog/static/fea72b8bb6c1352a510a256c539d4702/15bb5/qrcode.jpg 172w,/blog/static/fea72b8bb6c1352a510a256c539d4702/6ee52/qrcode.jpg 344w" alt=""/></picture><noscript><picture><source type="image/webp" srcSet="/blog/static/fea72b8bb6c1352a510a256c539d4702/ff4dd/qrcode.webp 86w,/blog/static/fea72b8bb6c1352a510a256c539d4702/d6c07/qrcode.webp 172w,/blog/static/fea72b8bb6c1352a510a256c539d4702/0f0fa/qrcode.webp 344w" sizes="(min-width: 344px) 344px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 344px) 344px, 100vw" decoding="async" loading="lazy" src="/blog/static/fea72b8bb6c1352a510a256c539d4702/6ee52/qrcode.jpg" srcSet="/blog/static/fea72b8bb6c1352a510a256c539d4702/8025c/qrcode.jpg 86w,/blog/static/fea72b8bb6c1352a510a256c539d4702/15bb5/qrcode.jpg 172w,/blog/static/fea72b8bb6c1352a510a256c539d4702/6ee52/qrcode.jpg 344w" alt=""/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1)}}</script></div><div>欢迎大家关注我的公众号-前端小板凳 一起学习进步！</div></div><div style="width:700px;margin:0 auto" id="vcomment"></div><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8259624032507561" crossorigin="anonymous"></script></div></div></main></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/react-setstate";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-66404c9e406180e64361.js"],"app":["/app-d0ee19b1d8c6e2977e87.js"],"component---src-pages-404-js":["/component---src-pages-404-js-b219e1422c8427174f7d.js"],"component---src-pages-category-js":["/component---src-pages-category-js-4d1df2e7c781eb4c2588.js"],"component---src-templates-category-detail-js":["/component---src-templates-category-detail-js-8ed1dc56766c71973f6f.js"],"component---src-templates-index-js":["/component---src-templates-index-js-f6260ca364886c7c794e.js"],"component---src-templates-post-js":["/component---src-templates-post-js-51ecaadd78c143c3f12f.js"]};/*]]>*/</script><script src="/blog/polyfill-66404c9e406180e64361.js" nomodule=""></script><script src="/blog/component---src-templates-post-js-51ecaadd78c143c3f12f.js" async=""></script><script src="/blog/6ba5cc0c8669d68fb0f844125a981d8f12367a97-80c1b264a8cd3e0a6a03.js" async=""></script><script src="/blog/a26abbfb03f25b9cd2b611d1d937ab5e796b3999-b150e4ff1a4c20fff1a0.js" async=""></script><script src="/blog/ef6529d7-5809e26836cfb9703dbc.js" async=""></script><script src="/blog/app-d0ee19b1d8c6e2977e87.js" async=""></script><script src="/blog/framework-30c1cbcd4309881b11c5.js" async=""></script><script src="/blog/webpack-runtime-7cf8a12991354380b805.js" async=""></script></body></html>